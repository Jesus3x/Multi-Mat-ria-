<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cl√≠nica77Digital Pro - Consultas Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="icon-192x192.png" />
    <link rel="apple-touch-icon" href="icon-192x192.png" />
    <meta name="theme-color" content="#facc15" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .service-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .service-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }
        
        .medical-service-btn {
            position: relative;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            color: white;
        }
        
        .medical-service-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .medical-service-btn:active {
            transform: translateY(0);
        }
        
        /* New Wide Button Styles */
        .medical-service-btn-wide {
            position: relative;
            padding: 16px 20px;
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            text-align: left;
            color: #1f2937;
            background: white;
        }
        
        .medical-service-btn-wide:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }
        
        .medical-service-btn-wide:active {
            transform: translateY(-1px);
        }
        
        .service-icon-left {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        
        .service-content-wide {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }
        
        .service-title-wide {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.2;
            color: #111827;
        }
        
        .service-desc-wide {
            font-size: 14px;
            opacity: 0.7;
            line-height: 1.3;
            color: #4b5563;
        }
        
        .service-status-wide {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
        }
        
        .status-text-wide {
            font-size: 12px;
            font-weight: 600;
            color: #059669;
        }
        
        .service-icon {
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .service-icon img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }
        
        .service-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 8px;
        }
        
        .service-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }
        
        .service-desc {
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.3;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .service-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: auto;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }
        
        .status-text {
            font-size: 10px;
            font-weight: 600;
            opacity: 0.9;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes pulse-dot {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .medical-service-btn {
                min-height: 90px;
                padding: 10px;
            }
            
            .service-title {
                font-size: 12px;
            }
            
            .service-desc {
                font-size: 10px;
            }
            
            .service-icon span {
                font-size: 20px;
            }
            
            /* Wide button responsive */
            .medical-service-btn-wide {
                height: 70px;
                padding: 12px 16px;
            }
            
            .service-icon-left {
                width: 50px;
                height: 50px;
                margin-right: 12px;
            }
            
            .service-icon-left span {
                font-size: 24px;
            }
            
            .service-title-wide {
                font-size: 16px;
            }
            
            .service-desc-wide {
                font-size: 12px;
            }
            
            .status-text-wide {
                font-size: 11px;
            }
        }
        
        @media (max-width: 640px) {
            .medical-service-btn {
                min-height: 80px;
                padding: 8px;
            }
            
            .service-title {
                font-size: 11px;
            }
            
            .service-desc {
                font-size: 9px;
            }
            
            .service-icon span {
                font-size: 18px;
            }
            
            /* Wide button mobile */
            .medical-service-btn-wide {
                height: 65px;
                padding: 10px 14px;
            }
            
            .service-icon-left {
                width: 45px;
                height: 45px;
                margin-right: 10px;
            }
            
            .service-icon-left span {
                font-size: 20px;
            }
            
            .service-title-wide {
                font-size: 14px;
            }
            
            .service-desc-wide {
                font-size: 11px;
            }
            
            .service-status-wide {
                margin-left: 8px;
            }
            
            .status-text-wide {
                font-size: 10px;
            }
        }
        
        .chat-container {
            position: fixed;
            top: 50%;
            right: 20px;
            width: 320px;
            height: 480px;
            z-index: 999;
            transform: translateY(-50%) translateX(100vw);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .chat-container.open {
            transform: translateY(-50%) translateX(0);
        }
        
        .auto-chat-container {
            position: fixed;
            top: 50%;
            left: 20px;
            width: 320px;
            height: 480px;
            z-index: 999;
            transform: translateY(-50%) translateX(-100vw);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .auto-chat-container.open {
            transform: translateY(-50%) translateX(0);
        }
        
        .consultation-container {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 360px;
            height: 500px;
            z-index: 999;
            transform: translateX(-50%) translateY(-50%) scale(0);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .consultation-container.open {
            transform: translateX(-50%) translateY(-50%) scale(1);
        }
        
        .pharmacy-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 360px;
            height: 520px;
            z-index: 999;
            transform: translateY(-100vh);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .pharmacy-container.open {
            transform: translateY(0);
        }
        
        .nutrition-container {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 400px;
            height: 550px;
            z-index: 999;
            transform: translateX(-50%) translateY(-50%) scale(0);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .nutrition-container.open {
            transform: translateX(-50%) translateY(-50%) scale(1);
        }
        
        .addiction-container {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 400px;
            height: 550px;
            z-index: 999;
            transform: translateX(-50%) translateY(-50%) scale(0);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .addiction-container.open {
            transform: translateX(-50%) translateY(-50%) scale(1);
        }
        
        .message-bubble {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .recording {
            animation: recordPulse 1s infinite;
        }
        
        @keyframes recordPulse {
            0% { background-color: #ef4444; }
            50% { background-color: #dc2626; }
            100% { background-color: #ef4444; }
        }
        
        .hero-text {
            animation: fadeInUp 1s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .services-grid {
            animation: fadeIn 1.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .video-player {
            position: relative;
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Notification Container -->
    <div id="notificationContainer"></div>
  <div class="bg-white text-center px-4 py-12">
    <h1 class="text-5xl md:text-6xl font-bold text-blue-900 mb-6"
        style="text-shadow: 
            0 1px 1px rgba(0, 0, 0, 0.1), 
            0 2px 4px rgba(0, 0, 0, 0.1);">
        üè• Cl√≠nica Digital Pro
    </h1>

    <p class="text-lg md:text-2xl max-w-3xl mx-auto text-teal-700"
        style="text-shadow: 
            0 1px 1px rgba(0, 0, 0, 0.05);">
        Cuidando da sua sa√∫de com tecnologia, seguran√ßa e conforto ‚Äî diretamente do navegador.
    </p>
</div>
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-900 via-teal-800 to-green-800 py-4 px-4 shadow-2xl border-b-4 border-blue-300">
        <div class="max-w-7xl mx-auto">
            <!-- Top Row: Logo and Navigation -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-2xl">üè•</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Cl√≠nica Digital Pro</h1>
                        <p class="text-sm text-blue-200">Cuidados m√©dicos inteligentes</p>
                    </div>
                </div>
                <nav class="flex flex-wrap items-center space-x-4 md:space-x-6">
                    <a href="#services" class="hover:text-blue-200 transition text-sm md:text-base text-white">Servi√ßos</a>
                    <a href="#consultation" class="hover:text-blue-200 transition text-sm md:text-base text-white">Consultas</a>
                    <a href="#about" class="hover:text-blue-200 transition text-sm md:text-base hidden md:inline text-white">Sobre</a>
                    <a href="#contact" class="hover:text-blue-200 transition text-sm md:text-base hidden md:inline text-white">Contato</a>
                </nav>
            </div>
            
            <!-- Medical Services Row - Vertical Stack -->
            <div class="flex flex-col gap-2 max-w-4xl mx-auto">
                <!-- Pharmacy Finder Button -->
                <button onclick="togglePharmacyFinder()" class="medical-service-btn-wide bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-200 hover:border-orange-400 shadow-lg hover:shadow-xl">
                    <div class="service-icon-left">
                        <!-- √çcone personalizado: substitua por <img src="URL_DO_ICONE" alt="Farm√°cia"> se desejar -->
                        <span class="text-3xl">üíä</span>
                    </div>
                    <div class="service-content-wide">
                        <h3 class="service-title-wide">Farm√°cias Pr√≥ximas</h3>
                        <p class="service-desc-wide">Encontre medicamentos e farm√°cias na sua regi√£o</p>
                    </div>
                    <div class="service-status-wide">
                        <span class="status-dot bg-green-500"></span>
                        <span class="status-text-wide">Online</span>
                    </div>
                </button>
                
                <!-- Auto Support Chat Button -->
                <button onclick="toggleAutoChat()" class="medical-service-btn-wide bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-200 hover:border-emerald-400 shadow-lg hover:shadow-xl">
                    <div class="service-icon-left">
                        <!-- √çcone personalizado: substitua por <img src="URL_DO_ICONE" alt="Autoatendimento"> se desejar -->
                        <span class="text-3xl">ü§ñ</span>
                    </div>
                    <div class="service-content-wide">
                        <h3 class="service-title-wide">Autoatendimento Virtual</h3>
                        <p class="service-desc-wide">Assistente m√©dico virtual especializado</p>
                    </div>
                    <div class="service-status-wide">
                        <span class="status-dot bg-green-500"></span>
                        <span class="status-text-wide">Online</span>
                    </div>
                </button>
                
                <!-- Consultation Rooms Button -->
                <button onclick="toggleConsultation()" class="medical-service-btn-wide bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-200 hover:border-indigo-400 shadow-lg hover:shadow-xl">
                    <div class="service-icon-left">
                        <!-- √çcone personalizado: substitua por <img src="URL_DO_ICONE" alt="Consultas"> se desejar -->
                        <span class="text-3xl">üè•</span>
                    </div>
                    <div class="service-content-wide">
                        <h3 class="service-title-wide">Salas de Consulta Especializadas</h3>
                        <p class="service-desc-wide">M√©dicos especialistas online agora mesmo</p>
                    </div>
                    <div class="service-status-wide">
                        <span class="status-dot bg-green-500"></span>
                        <span class="status-text-wide">3 M√©dicos</span>
                    </div>
                </button>
                
                <!-- Live Chat Button -->
                <button onclick="toggleChat()" class="medical-service-btn-wide bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-200 hover:border-blue-400 shadow-lg hover:shadow-xl">
                    <div class="service-icon-left">
                        <!-- √çcone personalizado: substitua por <img src="URL_DO_ICONE" alt="Chat"> se desejar -->
                        <span class="text-3xl">üí¨</span>
                    </div>
                    <div class="service-content-wide">
                        <h3 class="service-title-wide">Chat ao Vivo M√©dico</h3>
                        <p class="service-desc-wide">Suporte m√©dico em tempo real com profissionais</p>
                    </div>
                    <div class="service-status-wide">
                        <span class="status-dot bg-green-500"></span>
                        <span class="status-text-wide">2 Online</span>
                    </div>
                </button>
                
                <!-- Nutrition Chat Button -->
                <button onclick="toggleNutritionChat()" class="medical-service-btn-wide bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-200 hover:border-lime-400 shadow-lg hover:shadow-xl">
                    <div class="service-icon-left">
                        <!-- √çcone personalizado: substitua por <img src="URL_DO_ICONE" alt="Nutri√ß√£o"> se desejar -->
                        <span class="text-3xl">ü•ó</span>
                    </div>
                    <div class="service-content-wide">
                        <h3 class="service-title-wide">Dr. Nutricionista</h3>
                        <p class="service-desc-wide">Orienta√ß√£o nutricional personalizada</p>
                    </div>
                    <div class="service-status-wide">
                        <span class="status-dot bg-green-500"></span>
                        <span class="status-text-wide">Dispon√≠vel</span>
                    </div>
                </button>
                
                <!-- Psychology Chat Button -->
                <button onclick="togglePsychologyChat()" class="medical-service-btn-wide bg-white hover:bg-gray-50 text-gray-800 border-2 border-gray-200 hover:border-pink-400 shadow-lg hover:shadow-xl">
                    <div class="service-icon-left">
                        <!-- √çcone personalizado: substitua por <img src="URL_DO_ICONE" alt="Psicologia"> se desejar -->
                        <span class="text-3xl">üß†</span>
                    </div>
                    <div class="service-content-wide">
                        <h3 class="service-title-wide">Dr. Psic√≥logo</h3>
                        <p class="service-desc-wide">Especialista em v√≠cios e sa√∫de mental</p>
                    </div>
                    <div class="service-status-wide">
                        <span class="status-dot bg-green-500"></span>
                        <span class="status-text-wide">Ativo</span>
                    </div>
                </button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="gradient-bg py-20 px-4">
        <div class="max-w-4xl mx-auto text-center hero-text">
            <h2 class="text-5xl font-bold mb-6">Cuidados M√©dicos Inteligentes</h2>
            <p class="text-xl mb-8 opacity-90">Consultas online avan√ßada e especialistas qualificados</p>
            <button onclick="scrollToServices()" class="bg-white text-green-600 px-8 py-4 rounded-full font-semibold hover:bg-gray-100 transition transform hover:scale-105">
                Explorar Servi√ßos
            </button>
        </div>
    </section>

    <!-- AI Diagnosis Section -->
    <section class="py-20 px-4 bg-gray-800">
        <div class="max-w-4xl mx-auto text-center">
            <h3 class="text-4xl font-bold mb-8"> Diagn√≥stico </h3>
            <p class="text-xl mb-8 text-gray-300">Descreva seus sintomas e receba uma an√°lise preliminar.</p>
            
            <div class="bg-gray-900 rounded-2xl p-8 max-w-2xl mx-auto">
                <div class="mb-6">
                    <textarea 
                        id="symptomsInput" 
                        placeholder="Descreva seus sintomas detalhadamente..."
                        class="w-full bg-gray-800 p-4 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600 h-32 resize-none"
                    ></textarea>
                </div>
                
                <button 
                    onclick="analyzeSymptoms()" 
                    id="analyzeBtn"
                    class="w-full bg-gradient-to-r from-green-500 to-emerald-600 py-4 rounded-xl font-semibold hover:from-green-600 hover:to-emerald-700 transition transform hover:scale-105"
                >
                    üîç Analisar Sintomas
                </button>
                
                <div id="diagnosisResult" class="mt-6 hidden">
                    <div class="bg-green-900 bg-opacity-50 rounded-xl p-6">
                        <h4 class="text-xl font-bold mb-4 text-green-300">üìã An√°lise Preliminar</h4>
                        <p id="diagnosisText" class="text-gray-200 mb-4"></p>
                        <div id="videoSection" class="mt-6"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Services Section -->
    <section id="services" class="py-20 px-4">
        <div class="max-w-6xl mx-auto">
            <h3 class="text-4xl font-bold text-center mb-16">Nossos Servi√ßos</h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 services-grid">
                <!-- Service 1 -->
                

                <!-- Service 2 -->
                

                <!-- Service 3 -->
                
                <!-- Service 5 -->
                <div class="service-card bg-gray-800 rounded-2xl p-6 border border-gray-700">
                

                <!-- Service 6 -->
                <div class="service-card bg-gray-800 rounded-2xl p-6 border border-gray-700">
                    <div class="w-20 h-20 bg-gradient-to-r from-teal-500 to-green-600 rounded-2xl mb-4 flex items-center justify-center text-3xl">
                        üíä
                    </div>
                    <h4 class="text-2xl font-bold mb-3">Farm√°cia Online</h4>
                    <p class="text-gray-300 mb-6">Medicamentos com receita digital e entrega em domic√≠lio</p>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-2xl font-bold text-green-400">Consulte</span>
                        <div class="flex text-yellow-400">
                            ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
                        </div>
                    </div>
                    <button onclick="bookConsultation('Farm√°cia', '0')" class="w-full bg-gradient-to-r from-teal-500 to-green-600 py-3 rounded-xl font-semibold hover:from-teal-600 hover:to-green-700 transition">
                        Ver Medicamentos
                    </button>
                </div>
            </div>
        </div>
    </section>



    <!-- Footer -->
    <footer class="bg-gray-800 py-12 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <h4 class="text-2xl font-bold mb-4">Cl√≠nica Digital Pro</h4>
            <p class="text-gray-400 mb-6">Cuidando da sua sa√∫de com tecnologia e humaniza√ß√£o</p>
            <div class="flex justify-center space-x-6">
                <a href="#" class="text-gray-400 hover:text-white transition">üìß contato@clinicadigital.com</a>
                <a href="#" class="text-gray-400 hover:text-white transition">üì± (11) 99999-9999</a>
                <a href="#" class="text-gray-400 hover:text-white transition">üè• Emerg√™ncia 24h</a>
            </div>
        </div>
    </footer>



    <!-- Auto Support Chat Container (Left) -->
    <div id="autoChatContainer" class="auto-chat-container bg-gray-900 rounded-2xl shadow-2xl border border-gray-600">
        <!-- Auto Chat Header -->
        <div class="bg-gradient-to-r from-green-500 to-teal-600 p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    ü§ñ
                </div>
                <div>
                    <h5 class="font-semibold">Autoatendimento</h5>
                    <p class="text-sm opacity-80">Respostas m√©dicas instant√¢neas</p>
                </div>
            </div>
            <button onclick="toggleAutoChat()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-full transition">
                ‚úï
            </button>
        </div>

        <!-- Auto Status Panel -->
        <div class="p-3 bg-green-900 bg-opacity-80 border-b border-gray-600">
            <p class="text-sm text-green-200 flex items-center">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                Assistente m√©dico online
            </p>
        </div>

        <!-- Auto Messages Area -->
        <div id="autoMessagesArea" class="flex-1 p-4 overflow-y-auto h-64 space-y-3">
            <div class="message-bubble bg-gray-700 p-3 rounded-xl max-w-xs">
                <p class="text-sm">üëã Ol√°! Sou seu assistente m√©dico virtual. Como posso ajudar?</p>
                <span class="text-xs text-gray-400">Bot ‚Ä¢ agora</span>
            </div>
            <div class="message-bubble bg-gray-700 p-3 rounded-xl max-w-xs">
                <p class="text-sm">ü©∫ Voc√™ pode perguntar sobre:</p>
                <ul class="text-xs mt-2 space-y-1">
                    <li>‚Ä¢ Sintomas e doen√ßas</li>
                    <li>‚Ä¢ Hor√°rios de consulta</li>
                    <li>‚Ä¢ Especialidades m√©dicas</li>
                    <li>‚Ä¢ Emerg√™ncias</li>
                    <li>‚Ä¢ Falar com m√©dico</li>
                </ul>
                <span class="text-xs text-gray-400">Bot ‚Ä¢ agora</span>
            </div>
        </div>

        <!-- Auto Input Area -->
        <div class="p-4 border-t border-gray-600 bg-gray-800">
            <div class="flex items-center space-x-2">
                <input type="text" id="autoMessageInput" placeholder="Digite sua pergunta m√©dica..." class="flex-1 bg-gray-900 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                <button onclick="sendAutoMessage()" class="bg-green-600 w-12 h-12 rounded-full hover:bg-green-700 transition flex-shrink-0 flex items-center justify-center">
                    üì§
                </button>
            </div>
        </div>
    </div>

    <!-- Consultation Rooms Container (Center) -->
    <div id="consultationContainer" class="consultation-container bg-gray-900 rounded-2xl shadow-2xl border border-gray-600">
        <!-- Consultation Header -->
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    üè•
                </div>
                <div>
                    <h5 class="font-semibold">Salas de Consulta</h5>
                    <p class="text-sm opacity-80">Especialistas online</p>
                </div>
            </div>
            <button onclick="toggleConsultation()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-full transition">
                ‚úï
            </button>
        </div>

        <!-- Room Selection -->
        <div id="roomSelection" class="p-4">
            <h6 class="font-semibold mb-4">Escolha uma sala de consulta:</h6>
            <div class="space-y-3">
                <button onclick="enterRoom('geral')" class="w-full bg-green-600 hover:bg-green-700 p-4 rounded-xl text-left transition">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">ü©∫</span>
                        <div>
                            <h7 class="font-semibold">Sala 1 - Cl√≠nica Geral</h7>
                            <p class="text-sm opacity-80">Dr. Cl√≠nico Geral - Online</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="enterRoom('cardio')" class="w-full bg-red-600 hover:bg-red-700 p-4 rounded-xl text-left transition">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">‚ù§Ô∏è</span>
                        <div>
                            <h7 class="font-semibold">Sala 2 - Cardiologia</h7>
                            <p class="text-sm opacity-80">Dr. Cardiologista - Online</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="enterRoom('derma')" class="w-full bg-blue-600 hover:bg-blue-700 p-4 rounded-xl text-left transition">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üß¥</span>
                        <div>
                            <h7 class="font-semibold">Sala 3 - Dermatologia</h7>
                            <p class="text-sm opacity-80">Dr. Dermatologista - Online</p>
                        </div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Room Chat (Hidden initially) -->
        <div id="roomChat" class="hidden flex flex-col h-full">
            <div id="roomHeader" class="p-4 bg-gray-800 border-b border-gray-600 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span id="roomIcon" class="text-2xl">ü©∫</span>
                        <div>
                            <h6 id="roomTitle" class="font-semibold">Sala de Consulta</h6>
                            <p id="roomDoctor" class="text-sm opacity-80">M√©dico Online</p>
                        </div>
                    </div>
                    <button onclick="leaveRoom()" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded-lg text-sm transition">
                        Sair
                    </button>
                </div>
            </div>
            
            <div id="roomMessages" class="flex-1 p-4 overflow-y-auto space-y-3 min-h-0">
            </div>
            
            <div class="p-4 border-t border-gray-600 bg-gray-800 flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <input type="text" id="roomMessageInput" placeholder="Digite sua mensagem para o m√©dico..." class="flex-1 bg-gray-900 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 border border-gray-600">
                    <button onclick="sendRoomMessage()" class="bg-purple-600 w-12 h-12 rounded-full hover:bg-purple-700 transition flex-shrink-0 flex items-center justify-center">
                        üì§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Nutrition Chat Container -->
    <div id="nutritionChatContainer" class="chat-container bg-gray-900 rounded-2xl shadow-2xl border border-gray-600">
        <!-- Nutrition Chat Header -->
        <div class="bg-gradient-to-r from-green-500 to-lime-600 p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    ü•ó
                </div>
                <div>
                    <h5 class="font-semibold">Dr - Nutricionista</h5>
                    <p class="text-sm opacity-80">‚Ä¢ Especialista em Nutri√ß√£o</p>
                </div>
            </div>
            <button onclick="closeNutritionChat()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-full transition">
                ‚úï
            </button>
        </div>

        <!-- Status Panel -->
        <div class="p-3 bg-green-900 bg-opacity-80 border-b border-gray-600">
            <p class="text-sm text-green-200 flex items-center">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                Nutricionista  online - 
            </p>
        </div>

        <!-- Messages Area -->
        <div id="nutritionMessagesArea" class="flex-1 p-4 overflow-y-auto h-64 space-y-3">
            <div class="message-bubble bg-gray-700 p-3 rounded-xl max-w-xs">
                <p class="text-sm">ü•ó Ol√°! Sou o Dr. Nutricionista. Posso ajudar com:</p>
                <ul class="text-xs mt-2 space-y-1">
                    <li>‚Ä¢ Planos alimentares personalizados</li>
                    <li>‚Ä¢ Receitas saud√°veis</li>
                    <li>‚Ä¢ Orienta√ß√µes nutricionais</li>
                    <li>‚Ä¢ Dietas espec√≠ficas</li>
                    <li>‚Ä¢ Suplementa√ß√£o</li>
                </ul>
                <span class="text-xs text-gray-400">Dr. Nutricionista ‚Ä¢ agora</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-600 bg-gray-800">
            <div class="flex items-center space-x-2">
                <input type="text" id="nutritionMessageInput" placeholder="Pergunte sobre nutri√ß√£o, dietas, receitas..." class="flex-1 bg-gray-900 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-green-500 border border-gray-600">
                <button onclick="sendNutritionChatMessage()" class="bg-green-600 w-12 h-12 rounded-full hover:bg-green-700 transition flex-shrink-0 flex items-center justify-center">
                    üì§
                </button>
            </div>
        </div>
    </div>

    <!-- Psychology Chat Container -->
    <div id="psychologyChatContainer" class="auto-chat-container bg-gray-900 rounded-2xl shadow-2xl border border-gray-600">
        <!-- Psychology Chat Header -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    üß†
                </div>
                <div>
                    <h5 class="font-semibold">Dr. - Psic√≥logo</h5>
                    <p class="text-sm opacity-80">‚Ä¢ Especialista em V√≠cios</p>
                </div>
            </div>
            <button onclick="closePsychologyChat()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-full transition">
                ‚úï
            </button>
        </div>

        <!-- Status Panel -->
        <div class="p-3 bg-purple-900 bg-opacity-80 border-b border-gray-600">
            <p class="text-sm text-purple-200 flex items-center">
                <span class="w-2 h-2 bg-purple-400 rounded-full mr-2 animate-pulse"></span>
                Dr. Psic√≥logo online
            </p>
        </div>

        <!-- Messages Area -->
        <div id="psychologyMessagesArea" class="flex-1 p-4 overflow-y-auto h-64 space-y-3">
            <div class="message-bubble bg-gray-700 p-3 rounded-xl max-w-xs">
                <p class="text-sm">üß† Ol√°! Sou o Dr. Psic√≥logo, especialista em v√≠cios. Posso ajudar com:</p>
                <ul class="text-xs mt-2 space-y-1">
                    <li>‚Ä¢ Tratamento de depend√™ncias</li>
                    <li>‚Ä¢ Ansiedade e depress√£o</li>
                    <li>‚Ä¢ Terapia comportamental</li>
                    <li>‚Ä¢ Apoio emocional</li>
                    <li>‚Ä¢ Estrat√©gias de enfrentamento</li>
                </ul>
                <span class="text-xs text-gray-400">Dr. Psic√≥logo ‚Ä¢ agora</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-600 bg-gray-800">
            <div class="flex items-center space-x-2">
                <input type="text" id="psychologyMessageInput" placeholder="Compartilhe seus sentimentos e preocupa√ß√µes..." class="flex-1 bg-gray-900 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 border border-gray-600">
                <button onclick="sendPsychologyChatMessage()" class="bg-purple-600 w-12 h-12 rounded-full hover:bg-purple-700 transition flex-shrink-0 flex items-center justify-center">
                    üì§
                </button>
            </div>
        </div>
    </div>

    <!-- Pharmacy Finder Container -->
    <div id="pharmacyContainer" class="pharmacy-container bg-gray-900 rounded-2xl shadow-2xl border border-gray-600">
        <!-- Pharmacy Header -->
        <div class="bg-gradient-to-r from-orange-500 to-red-600 p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    üíä
                </div>
                <div>
                    <h5 class="font-semibold">Farm√°cias Pr√≥ximas</h5>
                    <p class="text-sm opacity-80">Encontre medicamentos</p>
                </div>
            </div>
            <button onclick="togglePharmacyFinder()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-full transition">
                ‚úï
            </button>
        </div>

        <!-- Location Input Section -->
        <div class="p-4 border-b border-gray-600 bg-gray-800">
            <div class="space-y-3">
                <div class="flex space-x-2">
                    <input type="text" id="locationInput" placeholder="Ex: Centro, Universit√°rio, Kennedy, 55000-000..." class="flex-1 bg-gray-900 p-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 border border-gray-600">
                    <button onclick="searchByAddress()" class="bg-blue-600 hover:bg-blue-700 px-4 py-3 rounded-xl transition" title="Buscar em Caruaru">
                        üîç
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button onclick="useCurrentLocation()" class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 py-3 rounded-xl font-semibold hover:from-green-600 hover:to-teal-700 transition text-sm">
                        üìç Minha Localiza√ß√£o
                    </button>
                    <button onclick="clickOnMap()" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-indigo-700 transition text-sm">
                        üó∫Ô∏è Clicar no Mapa
                    </button>
                </div>
                <input type="text" id="medicineSearch" placeholder="Buscar medicamento..." class="w-full bg-gray-900 p-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 border border-gray-600">
            </div>
        </div>

        <!-- Map Container -->
        <div id="mapContainer" class="h-32 bg-gray-800 border-b border-gray-600 relative">
            <div id="map" class="w-full h-full rounded-lg cursor-pointer"></div>
            <div id="mapPlaceholder" class="w-full h-full flex items-center justify-center text-gray-400">
                <div class="text-center">
                    <div class="text-4xl mb-2">üó∫Ô∏è</div>
                    <p class="text-sm">Digite um bairro de Caruaru ou use GPS</p>
                    <p class="text-xs text-gray-500 mt-1">Centro ‚Ä¢ Universit√°rio ‚Ä¢ Kennedy ‚Ä¢ Maur√≠cio de Nassau</p>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div id="pharmacyResults" class="flex-1 p-3 overflow-y-auto" style="height: 180px;">
            <div class="text-center text-gray-400">
                <div class="text-3xl mb-2">üíä</div>
                <p class="text-sm">Digite um bairro de Caruaru-PE</p>
                <p class="text-xs text-gray-500 mt-2">Centro, Universit√°rio, Kennedy, Maur√≠cio de Nassau...</p>
            </div>
        </div>
    </div>

    <!-- Live Chat Container (Right) -->
    <div id="chatContainer" class="chat-container bg-gray-900 rounded-2xl shadow-2xl border border-gray-600">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    üí¨
                </div>
                <div>
                    <h5 class="font-semibold">Chat Ao Vivo</h5>
                    <p class="text-sm opacity-80" id="onlineUsers">2 usu√°rios online</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-full transition">
                ‚úï
            </button>
        </div>

        <!-- Status Panel -->
        <div id="statusPanel" class="p-3 bg-green-900 bg-opacity-80 border-b border-gray-600">
            <p class="text-sm text-green-200 flex items-center">
                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                Chat conectado e funcionando
            </p>
        </div>

        <!-- Messages Area -->
        <div id="messagesArea" class="flex-1 p-4 overflow-y-auto h-64 space-y-3">
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-600 bg-gray-800">
            <div class="flex items-center space-x-2">
                <!-- Bot√£o de Imagem -->
                <input type="file" id="imageInput" accept="image/*" onchange="sendImage()" class="hidden">
                <button onclick="document.getElementById('imageInput').click()" class="bg-green-600 w-10 h-10 rounded-full hover:bg-green-700 transition flex-shrink-0 flex items-center justify-center" title="Enviar foto">
                    üì∑
                </button>
                
                <!-- Campo de Mensagem -->
                <input type="text" id="messageInput" placeholder="Digite sua mensagem..." class="flex-1 bg-gray-900 p-3 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 border border-gray-600">
                
                <!-- Bot√£o Principal (√Åudio/Envio) -->
                <button id="mainActionBtn" onclick="handleMainAction()" class="bg-blue-600 w-12 h-12 rounded-full hover:bg-blue-700 transition flex-shrink-0 flex items-center justify-center">
                    <span id="mainActionIcon">üì§</span>
                </button>
            </div>
            
            <!-- Status do Microfone -->
            <div id="micStatus" class="mt-2 text-xs text-gray-400 text-center hidden">
                <span class="flex items-center justify-center">
                    <span class="w-2 h-2 bg-red-500 rounded-full mr-2 animate-pulse"></span>
                    Gravando √°udio... Toque para parar
                </span>
            </div>
        </div>
    </div>

    <!-- Audio Elements for Notifications -->
    <audio id="sendSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    <audio id="receiveSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>

    <script>
        // API Configuration - CONFIGURE SUAS CHAVES AQUI
        
        
        // Firebase Configuration - CONFIGURE SEU FIREBASE AQUI
        const firebaseConfig = {
  apiKey: "AIzaSyDAYD7DhRovj0PYHUSpOq5YE1rQXIiOPkc",
  authDomain: "chat-trader.firebaseapp.com",
  databaseURL: "https://chat-trader-default-rtdb.firebaseio.com",
  projectId: "chat-trader",
  storageBucket: "chat-trader.firebasestorage.app",
  messagingSenderId: "722204996123",
  appId: "1:722204996123:web:6ab7fd6a6b5646c3e0bebe",
  measurementId: "G-N36TE38K29"
};

        let database = null;
        let messagesRef = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let chatOpen = false;
        let autoChatOpen = false;
        let consultationOpen = false;
        let firebaseConnected = false;
        let currentRoom = null;
        let pharmacyOpen = false;
        let userLocation = null;
        let map = null;
        let pharmacyMarkers = [];

        // Demo WebSocket for real-time communication
        let ws = null;
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);

        // Enhanced Notification System with Push Notifications
        function showNotification(title, message, type = 'info', playSound = true) {
            // In-app notification
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'from-green-500 to-emerald-600',
                error: 'from-red-500 to-pink-600',
                warning: 'from-yellow-500 to-orange-600',
                info: 'from-blue-500 to-purple-600',
                message: 'from-purple-500 to-indigo-600'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå', 
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                message: 'üí¨'
            };
            
            notification.className = `notification bg-gradient-to-r ${colors[type]} p-4 rounded-xl shadow-2xl max-w-sm border border-white border-opacity-20`;
            notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <span class="text-2xl animate-bounce">${icons[type]}</span>
                    <div class="flex-1">
                        <h6 class="font-bold text-white">${title}</h6>
                        <p class="text-sm text-white opacity-90">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:bg-white hover:bg-opacity-20 p-1 rounded-full transition">‚úï</button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Show notification with animation
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Play notification sound
            if (playSound) {
                playNotificationSound(type);
            }
            
            // Auto remove after 6 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 6000);
            
            // Browser push notification
            showBrowserNotification(title, message, type);
        }
        
        // Browser Push Notifications
        function showBrowserNotification(title, message, type) {
            if (!('Notification' in window)) {
                console.log('Este navegador n√£o suporta notifica√ß√µes push');
                return;
            }
            
            if (Notification.permission === 'granted') {
                const options = {
                    body: message,
                    icon: getNotificationIcon(type),
                    badge: 'üè•',
                    tag: 'clinica-digital',
                    requireInteraction: type === 'error' || type === 'warning',
                    silent: false,
                    vibrate: [200, 100, 200],
                    actions: [
                        {
                            action: 'view',
                            title: 'Ver',
                            icon: 'üëÅÔ∏è'
                        },
                        {
                            action: 'close',
                            title: 'Fechar',
                            icon: '‚úï'
                        }
                    ]
                };
                
                const notification = new Notification(title, options);
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
                
                // Auto close after 8 seconds
                setTimeout(() => {
                    notification.close();
                }, 8000);
                
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showBrowserNotification(title, message, type);
                    }
                });
            }
        }
        
        function getNotificationIcon(type) {
            const icons = {
                success: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%2310b981"/><path d="M30 50l10 10 20-20" stroke="white" stroke-width="4" fill="none"/></svg>',
                error: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23ef4444"/><path d="M35 35l30 30M65 35l-30 30" stroke="white" stroke-width="4"/></svg>',
                warning: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23f59e0b"/><path d="M50 25v30M50 65v5" stroke="white" stroke-width="4"/></svg>',
                info: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%233b82f6"/><path d="M50 35v30M50 25v5" stroke="white" stroke-width="4"/></svg>',
                message: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%238b5cf6"/><path d="M25 40h50v20H35l-10 10V40z" fill="white"/></svg>'
            };
            return icons[type] || icons.info;
        }
        
        // Enhanced Sound System
        function playNotificationSound(type) {
            const sounds = {
                success: createNotificationTone(800, 0.1, 'sine'),
                error: createNotificationTone(300, 0.2, 'square'),
                warning: createNotificationTone(600, 0.15, 'triangle'),
                info: createNotificationTone(500, 0.1, 'sine'),
                message: createNotificationTone(700, 0.1, 'sine'),
                send: createNotificationTone(900, 0.08, 'sine'),
                receive: createNotificationTone(600, 0.12, 'sine')
            };
            
            if (sounds[type]) {
                sounds[type]();
            }
        }
        
        function createNotificationTone(frequency, duration, waveType = 'sine') {
            return function() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = waveType;
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration);
                } catch (error) {
                    console.log('√Åudio n√£o dispon√≠vel:', error);
                }
            };
        }

        // Verifica√ß√£o de API Keys
        function checkApiKeys() {
            console.log('üîç Verificando configura√ß√£o das APIs...');
            
            if (!isGeminiConfigured()) {
                console.warn('‚ö†Ô∏è API n√£o configurada');
                showNotification('API n√£o configurada!', 'Configure sua chave no c√≥digo', 'warning');
            } else {
                console.log('‚úÖ API configurada');
            }
            
            if (!isYouTubeConfigured()) {
                console.warn('‚ö†Ô∏è YouTube API n√£o configurada');
            } else {
                console.log('‚úÖ YouTube API configurada');
            }
        }

        // AI Specialist Response System
        async function getAISpecialistResponse(patientMessage, roomType) {
            if (!isGeminiConfigured()) {
                throw new Error('API n√£o configurada');
            }
            
            // Validar se o roomType √© v√°lido
            if (!roomType || !['geral', 'cardio', 'derma'].includes(roomType)) {
                console.error(`‚ùå Tipo de sala inv√°lido: ${roomType}`);
                throw new Error(`Tipo de sala inv√°lido: ${roomType}`);
            }
            
            const specialistPrompts = {
                'geral': {
                    persona: 'Dr. Cl√≠nico Geral, m√©dico com 15 anos de experi√™ncia',
                    context: 'Voc√™ √© um cl√≠nico geral experiente que atende pacientes com diversas condi√ß√µes de sa√∫de. Seja emp√°tico, profissional e forne√ßa orienta√ß√µes m√©dicas gerais.',
                    expertise: 'medicina geral, diagn√≥stico inicial, preven√ß√£o, cuidados b√°sicos de sa√∫de, sintomas gerais',
                    greeting: 'Ol√°! Sou o Dr. Cl√≠nico Geral.'
                },
                'cardio': {
                    persona: 'Dr. Cardiologista, especialista com 12 anos de experi√™ncia',
                    context: 'Voc√™ √© um cardiologista experiente especializado em sa√∫de cardiovascular. Foque EXCLUSIVAMENTE em quest√µes do cora√ß√£o, press√£o arterial, colesterol e preven√ß√£o cardiovascular.',
                    expertise: 'cardiologia, hipertens√£o, arritmias, insufici√™ncia card√≠aca, preven√ß√£o cardiovascular, colesterol, dor no peito, palpita√ß√µes',
                    greeting: 'Ol√°! Sou o Dr. Cardiologista.'
                },
                'derma': {
                    persona: 'Dr. Dermatologista, especialista com 10 anos de experi√™ncia',
                    context: 'Voc√™ √© um dermatologista experiente especializado EXCLUSIVAMENTE em sa√∫de da pele, cabelo e unhas. Foque apenas em problemas dermatol√≥gicos, cuidados com a pele e tratamentos dermatol√≥gicos.',
                    expertise: 'dermatologia, acne, eczema, psor√≠ase, c√¢ncer de pele, cuidados com a pele, cabelo, unhas, manchas, coceira, les√µes cut√¢neas',
                    greeting: 'Ol√°! Sou o Dr. Dermatologista.'
                }
            };
            
            const specialist = specialistPrompts[roomType];
            
            if (!specialist) {
                console.error(`‚ùå Especialista n√£o encontrado para: ${roomType}`);
                throw new Error(`Especialista n√£o encontrado para: ${roomType}`);
            }
            
            const prompt = `Voc√™ √© ${specialist.persona}.

IMPORTANTE: Voc√™ DEVE responder APENAS como este especialista espec√≠fico.

CONTEXTO: ${specialist.context}

ESPECIALIDADE EXCLUSIVA: ${specialist.expertise}

INSTRU√á√ïES OBRIGAT√ìRIAS:
- Responda SEMPRE como ${specialist.persona}
- Inicie com: "${specialist.greeting}"
- Use linguagem profissional mas acess√≠vel
- Seja emp√°tico e acolhedor
- Forne√ßa orienta√ß√µes m√©dicas ESPEC√çFICAS da sua especialidade
- Se a pergunta N√ÉO for da sua √°rea, diga: "Esta quest√£o n√£o √© da minha especialidade como [sua especialidade]. Recomendo consultar um [especialista correto]."
- Sempre inclua disclaimer sobre consulta presencial quando necess√°rio
- Limite sua resposta a 150 palavras
- Use portugu√™s brasileiro
- NUNCA responda sobre outras especialidades

PERGUNTA DO PACIENTE: "${patientMessage}"

Responda EXCLUSIVAMENTE como ${specialist.persona}:`;

            console.log(`ü©∫ Consultando ${specialist.persona} para sala: ${roomType}...`);
            
            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    maxOutputTokens: 250,
                    temperature: 0.3, // Reduzido para mais consist√™ncia
                    topP: 0.8,
                    topK: 40
                }
            };
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error('‚ùå Erro da API Gemini:', errorData);
                throw new Error(`Erro da API: ${response.status} - ${errorData.error?.message || 'Erro desconhecido'}`);
            }
            
            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                const aiResponse = data.candidates[0].content.parts[0].text;
                console.log(`‚úÖ Resposta do ${specialist.persona} recebida para sala ${roomType}`);
                
                // Validar se a resposta cont√©m a identifica√ß√£o do especialista
                if (!aiResponse.includes(specialist.greeting.split(',')[0])) {
                    console.warn(`‚ö†Ô∏è Resposta pode n√£o estar correta para ${specialist.persona}`);
                }
                
                return aiResponse;
            } else {
                console.error('‚ùå Estrutura de resposta inv√°lida:', data);
                throw new Error('Resposta da API em formato inv√°lido');
            }
        }
        
        // Typing Indicator Functions
        function addTypingIndicator() {
            const messagesArea = document.getElementById('roomMessages');
            const typingDiv = document.createElement('div');
            const typingId = 'typing_' + Date.now();
            
            typingDiv.id = typingId;
            typingDiv.className = 'message-bubble bg-gray-700 p-3 rounded-xl max-w-xs';
            typingDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-xs text-gray-400">M√©dico digitando...</span>
                </div>
            `;
            
            messagesArea.appendChild(typingDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            return typingId;
        }
        
        function removeTypingIndicator(typingId) {
            const typingElement = document.getElementById(typingId);
            if (typingElement) {
                typingElement.remove();
            }
        }

        // Gemini AI Integration
        async function analyzeSymptoms() {
            const symptomsInput = document.getElementById('symptomsInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const diagnosisResult = document.getElementById('diagnosisResult');
            const diagnosisText = document.getElementById('diagnosisText');
            
            const symptoms = symptomsInput.value.trim();
            
            if (!symptoms) {
                showNotification('Aten√ß√£o!', 'Por favor, descreva seus sintomas', 'warning');
                return;
            }
            
            if (!isGeminiConfigured()) {
                showNotification('API n√£o configurada!', 'Substitua SUA_CHAVE_AQUI pela sua chave real no c√≥digo', 'error');
                console.error('‚ùå API Key n√£o configurada corretamente');
                return;
            }
            
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = 'üîÑ Analisando...';
            
            console.log('üöÄ Iniciando an√°lise m√©dica...');
            
            try {
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: `Voc√™ √© um assistente m√©dico virtual. Analise os sintomas descritos e forne√ßa uma resposta em portugu√™s brasileiro com no m√°ximo 200 palavras.

Inclua:
1. Poss√≠veis causas
2. Cuidados b√°sicos recomendados  
3. Quando procurar ajuda m√©dica
4. Disclaimer: "Esta √© apenas uma an√°lise preliminar e n√£o substitui consulta m√©dica profissional"

Sintomas relatados: ${symptoms}`
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 300,
                        temperature: 0.3,
                        topP: 0.8,
                        topK: 40
                    }
                };
                
                console.log('üì§ Enviando requisi√ß√£o para an√°lise...');
                
                const response = await fetch("/gemini-api", {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(requestBody),
});




                
                console.log('üì• Resposta recebida:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Erro da API:', errorData);
                    throw new Error(`Erro da API: ${response.status} - ${errorData.error?.message || 'Erro desconhecido'}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Dados recebidos:', data);
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const diagnosis = data.candidates[0].content.parts[0].text;
                    diagnosisText.innerHTML = diagnosis.replace(/\n/g, '<br>');
                    diagnosisResult.classList.remove('hidden');
                    
                    // Search for related videos
                    searchHealthVideos(symptoms);
                    
                    showNotification('An√°lise conclu√≠da!', 'Relat√≥rio m√©dico gerado com sucesso', 'success');
                    console.log('‚úÖ An√°lise conclu√≠da com sucesso');
                } else {
                    console.error('‚ùå Estrutura de resposta inv√°lida:', data);
                    throw new Error('Resposta da API em formato inv√°lido');
                }
                
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                let errorMessage = 'Erro ao analisar sintomas: ';
                
                if (error.message.includes('API key')) {
                    errorMessage += 'Chave da API inv√°lida';
                } else if (error.message.includes('quota')) {
                    errorMessage += 'Limite de uso da API excedido';
                } else if (error.message.includes('network')) {
                    errorMessage += 'Erro de conex√£o';
                } else {
                    errorMessage += error.message;
                }
                
                showNotification('Erro na an√°lise!', errorMessage, 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'üîç Analisar Sintomas';
            }
        }

        // YouTube API Integration
        async function searchHealthVideos(query) {
            if (!isYouTubeConfigured()) {
                console.log('üì∫ YouTube API n√£o configurada - pulando busca de v√≠deos');
                return;
            }
            
            try {
                console.log('üîç Buscando v√≠deos relacionados...');
                const searchQuery = `${query} sa√∫de medicina tratamento cuidados`;
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=3&q=${encodeURIComponent(searchQuery)}&type=video&regionCode=BR&relevanceLanguage=pt&key=${YOUTUBE_API_KEY}`;
                
                const response = await fetch(`/youtube-search?q=${encodeURIComponent(termo)}`);

¬† headers: {
¬† ¬† 'Content-Type': 'application/json'
¬† },
¬† 
});

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Erro YouTube API:', errorData);
                    throw new Error(`Erro YouTube: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì∫ V√≠deos encontrados:', data.items?.length || 0);
                
                if (data.items && data.items.length > 0) {
                    displayHealthVideos(data.items);
                } else {
                    console.log('üì∫ Nenhum v√≠deo encontrado para:', query);
                }
            } catch (error) {
                console.error('‚ùå Erro ao buscar v√≠deos:', error);
                // N√£o mostrar erro para o usu√°rio, apenas log
            }
        }

        function displayHealthVideos(videos) {
            const videoSection = document.getElementById('videoSection');
            
            let videosHtml = '<h5 class="text-lg font-semibold mb-4 text-green-300">üì∫ V√≠deos Educativos</h5>';
            
            videos.forEach(video => {
                videosHtml += `
                    <div class="bg-gray-800 rounded-lg p-4 mb-3">
                        <div class="flex items-start space-x-3">
                            <img src="${video.snippet.thumbnails.default.url}" alt="Thumbnail" class="w-20 h-15 rounded object-cover">
                            <div class="flex-1">
                                <h6 class="font-semibold text-sm mb-2">${video.snippet.title}</h6>
                                <p class="text-xs text-gray-400 mb-2">${video.snippet.channelTitle}</p>
                                <button onclick="playVideo('${video.id.videoId}')" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs transition">
                                    ‚ñ∂Ô∏è Assistir
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            videoSection.innerHTML = videosHtml;
        }

        function playVideo(videoId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-xl p-6 max-w-4xl w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üì∫ V√≠deo Educativo</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white text-2xl">‚úï</button>
                    </div>
                    <div class="aspect-video">
                        <iframe 
                            width="100%" 
                            height="100%" 
                            src="https://www.youtube.com/embed/${videoId}" 
                            frameborder="0" 
                            allowfullscreen
                            class="rounded-lg"
                        ></iframe>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Consultation Rooms
        function toggleConsultation() {
            const consultationContainer = document.getElementById('consultationContainer');
            consultationOpen = !consultationOpen;
            
            if (consultationOpen) {
                consultationContainer.classList.add('open');
                showRoomSelection();
            } else {
                consultationContainer.classList.remove('open');
                leaveRoom();
            }
        }

        function showRoomSelection() {
            document.getElementById('roomSelection').classList.remove('hidden');
            document.getElementById('roomChat').classList.add('hidden');
            currentRoom = null;
        }

        function enterRoom(roomType) {
            currentRoom = roomType;
            console.log(`üö™ Entrando na sala: ${roomType}`);
            
            const roomData = {
                'geral': {
                    icon: 'ü©∫',
                    title: 'Sala 1 - Cl√≠nica Geral',
                    doctor: 'Dr. Cl√≠nico Geral - Online',
                    welcome: 'Ol√°! Sou o Dr. Cl√≠nico Geral. Tenho 15 anos de experi√™ncia em medicina geral. Como posso ajud√°-lo hoje? Pode me contar seus sintomas ou d√∫vidas de sa√∫de.',
                    specialty: 'Cl√≠nica Geral',
                    aiPersona: 'Dr. Cl√≠nico Geral'
                },
                'cardio': {
                    icon: '‚ù§Ô∏è',
                    title: 'Sala 2 - Cardiologia',
                    doctor: 'Dr. Cardiologista - Online',
                    welcome: 'Ol√°! Sou o Dr. Cardiologista. Especializo-me em sa√∫de cardiovascular h√° 12 anos. Vamos cuidar do seu cora√ß√£o! Tem alguma preocupa√ß√£o card√≠aca?',
                    specialty: 'Cardiologia',
                    aiPersona: 'Dr. Cardiologista'
                },
                'derma': {
                    icon: 'üß¥',
                    title: 'Sala 3 - Dermatologia',
                    doctor: 'Dr. Dermatologista - Online',
                    welcome: 'Ol√°! Sou o Dr. Dermatologista. Cuido da sa√∫de da pele, cabelo e unhas h√° 10 anos. Como posso ajudar com sua pele hoje?',
                    specialty: 'Dermatologia',
                    aiPersona: 'Dr. Dermatologista'
                }
            };
            
            const room = roomData[roomType];
            
            if (!room) {
                console.error(`‚ùå Sala n√£o encontrada: ${roomType}`);
                showNotification('Erro!', `Sala ${roomType} n√£o encontrada`, 'error');
                return;
            }
            
            console.log(`‚úÖ Configurando sala: ${room.title} - ${room.aiPersona}`);
            
            document.getElementById('roomIcon').textContent = room.icon;
            document.getElementById('roomTitle').textContent = room.title;
            document.getElementById('roomDoctor').textContent = room.doctor;
            
            document.getElementById('roomSelection').classList.add('hidden');
            document.getElementById('roomChat').classList.remove('hidden');
            
            // Limpar mensagens anteriores
            const messagesArea = document.getElementById('roomMessages');
            messagesArea.innerHTML = '';
            
            // Add welcome message
            addRoomMessage(room.welcome, false, room.aiPersona);
            
            showNotification('Consulta iniciada!', `Voc√™ entrou na ${room.title}`, 'success');
            console.log(`üè• Sala ${roomType} configurada com sucesso - Especialista: ${room.aiPersona}`);
        }

        function leaveRoom() {
            if (currentRoom) {
                showNotification('Consulta finalizada!', 'Voc√™ saiu da sala de consulta', 'info');
            }
            showRoomSelection();
        }

        async function sendRoomMessage() {
            const input = document.getElementById('roomMessageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            if (!currentRoom) {
                showNotification('Erro!', 'Nenhuma sala selecionada', 'error');
                return;
            }
            
            addRoomMessage(text, true, 'Voc√™');
            input.value = '';
            
            // Show typing indicator
            const typingId = addTypingIndicator();
            
            // Dados dos especialistas por sala
            const roomData = {
                'geral': 'Dr. Cl√≠nico Geral',
                'cardio': 'Dr. Cardiologista', 
                'derma': 'Dr. Dermatologista'
            };
            
            console.log(`üè• Enviando pergunta para sala: ${currentRoom} (${roomData[currentRoom]})`);
            
            try {
                const response = await getAISpecialistResponse(text, currentRoom);
                removeTypingIndicator(typingId);
                
                console.log(`‚úÖ Resposta recebida do ${roomData[currentRoom]}`);
                addRoomMessage(response, false, roomData[currentRoom]);
                
            } catch (error) {
                removeTypingIndicator(typingId);
                console.error(`‚ùå Erro ao obter resposta para sala ${currentRoom}:`, error);
                
                // Fallback responses espec√≠ficos por especialidade
                const fallbackResponses = {
                    'geral': [
                        'Ol√°! Sou o Dr. Cl√≠nico Geral. Entendo sua preocupa√ß√£o. Pode me dar mais detalhes sobre os sintomas, quando come√ßaram e sua intensidade?',
                        'Como Dr. Cl√≠nico Geral com 15 anos de experi√™ncia, baseado no que descreveu, seria importante fazer uma avalia√ß√£o mais detalhada. H√° quanto tempo sente isso?',
                        'Sou o Dr. Cl√≠nico Geral. Vou anotar essas informa√ß√µes importantes. Tem hist√≥rico familiar de doen√ßas? Toma algum medicamento?',
                        'Como Dr. Cl√≠nico Geral, posso ajudar com diversos problemas de sa√∫de. Me conte mais sobre seu hist√≥rico m√©dico e sintomas atuais.'
                    ],
                    'cardio': [
                        'Ol√°! Sou o Dr. Cardiologista. Quest√µes do cora√ß√£o requerem aten√ß√£o especial. Me conte mais sobre dor no peito, palpita√ß√µes ou falta de ar.',
                        'Como Dr. Cardiologista com 12 anos de experi√™ncia, vamos investigar sua sa√∫de cardiovascular. Tem hist√≥rico familiar de problemas card√≠acos?',
                        'Sou o Dr. Cardiologista. √â importante monitorar esses sintomas card√≠acos. Qual sua press√£o arterial habitual? Faz exerc√≠cios regularmente?',
                        'Como Dr. Cardiologista, press√£o arterial, colesterol e ritmo card√≠aco s√£o fundamentais. Quando foi seu √∫ltimo eletrocardiograma?'
                    ],
                    'derma': [
                        'Ol√°! Sou o Dr. Dermatologista. Problemas de pele podem ter v√°rias causas. Pode descrever melhor a les√£o: cor, tamanho, localiza√ß√£o?',
                        'Como Dr. Dermatologista com 10 anos de experi√™ncia, vou examinar essa quest√£o. Quando come√ßou a notar essas altera√ß√µes na pele?',
                        'Sou o Dr. Dermatologista. Para cuidados com a pele, preciso entender melhor. H√° coceira, dor, descama√ß√£o ou mudan√ßa de cor?',
                        'Como Dr. Dermatologista, pele, cabelo e unhas s√£o minha especialidade. Me conte sobre exposi√ß√£o solar e hist√≥rico dermatol√≥gico.'
                    ]
                };
                
                const responses = fallbackResponses[currentRoom] || fallbackResponses['geral'];
                const fallbackResponse = responses[Math.floor(Math.random() * responses.length)];
                
                console.log(`üîÑ Usando resposta fallback para ${currentRoom}: ${roomData[currentRoom]}`);
                addRoomMessage(fallbackResponse, false, roomData[currentRoom]);
            }
        }

        function addRoomMessage(text, isUser, sender) {
            const messagesArea = document.getElementById('roomMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'ml-auto bg-purple-600' : 'bg-gray-700'} p-3 rounded-xl max-w-xs`;
            
            const time = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <p class="text-sm">${text}</p>
                <span class="text-xs text-gray-400">${sender} ‚Ä¢ ${time}</span>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Firebase and Chat Functions (keeping original functionality)
        function initializeFirebase() {
            if (firebaseConfig.apiKey === "SUA_API_KEY_AQUI") {
                console.log('Firebase n√£o configurado - usando modo demo');
                return false;
            }

            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                messagesRef = database.ref('messages');
                
                messagesRef.on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    if (message.userId !== userId) {
                        displayMessage(message, false);
                        playReceiveSound();
                        
                        // Show notification for new message
                        const messagePreview = message.text ? 
                            (message.text.length > 50 ? message.text.substring(0, 50) + '...' : message.text) :
                            message.type === 'image' ? 'üì∑ Imagem recebida' : 
                            message.type === 'audio' ? 'üé§ √Åudio recebido' : 'Nova mensagem';
                            
                        showNotification('Nova mensagem!', `${message.userName}: ${messagePreview}`, 'message');
                    }
                });

                firebaseConnected = true;
                return true;
            } catch (error) {
                console.error('Erro ao conectar com Firebase:', error);
                return false;
            }
        }

        function initWebSocket() {
            const connected = initializeFirebase();
        }

        // Auto Chat Functions
        function toggleAutoChat() {
            const autoChatContainer = document.getElementById('autoChatContainer');
            autoChatOpen = !autoChatOpen;
            
            if (autoChatOpen) {
                autoChatContainer.classList.add('open');
            } else {
                autoChatContainer.classList.remove('open');
            }
        }

        function sendAutoMessage() {
            const input = document.getElementById('autoMessageInput');
            const text = input.value.trim();
            
            if (!text) return;

            displayAutoMessage(text, true);
            
            setTimeout(() => {
                const response = responderAutomaticamente(text);
                displayAutoMessage(response, false);
            }, 800);
            
            input.value = '';
        }

        function displayAutoMessage(text, isUser) {
            const messagesArea = document.getElementById('autoMessagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'ml-auto bg-green-600' : 'bg-gray-700'} p-3 rounded-xl max-w-xs`;
            
            const time = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <p class="text-sm">${text}</p>
                <span class="text-xs text-gray-400">${isUser ? 'Voc√™' : 'Bot'} ‚Ä¢ ${time}</span>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function responderAutomaticamente(texto) {
            texto = texto.toLowerCase();

            if (["dor de cabe√ßa", "enxaqueca", "cefaleia"].some(p => texto.includes(p))) {
                return "ü©∫ Para dores de cabe√ßa: descanse, hidrate-se e evite luzes fortes. Se persistir, consulte um m√©dico.";
            }

            if (["febre", "temperatura", "calor"].some(p => texto.includes(p))) {
                return "üå°Ô∏è Para febre: mantenha-se hidratado, descanse e monitore a temperatura. Acima de 38¬∞C, procure ajuda m√©dica.";
            }

            if (["press√£o alta", "hipertens√£o", "press√£o"].some(p => texto.includes(p))) {
                return "‚ù§Ô∏è Para press√£o alta: reduza sal, exercite-se e monitore regularmente. Consulte um cardiologista.";
            }

            if (["consulta", "agendar", "marcar"].some(p => texto.includes(p))) {
                return "üìÖ Para agendar consultas: (11) 99999-9999 ou use nossas salas de consulta online üè•";
            }

            if (["emerg√™ncia", "urgente", "grave"].some(p => texto.includes(p))) {
                return "üö® EMERG√äNCIA: Ligue 192 (SAMU) ou v√° ao pronto-socorro mais pr√≥ximo imediatamente!";
            }

            if (["hor√°rio", "funcionamento", "atendimento"].some(p => texto.includes(p))) {
                return "üìÖ Atendimento: 24h online | Presencial: 08h-18h, seg-sex | Emerg√™ncia: 24h";
            }

            if (["pre√ßo", "valor", "custo", "consulta"].some(p => texto.includes(p))) {
                return "üí∞ Consultas: R$ 89,90 (Geral) a R$ 149,90 (Especialistas). Conv√™nios aceitos!";
            }

            if (["m√©dico", "doutor", "especialista"].some(p => texto.includes(p))) {
                return "üë®‚Äç‚öïÔ∏è Temos especialistas em: Cl√≠nica Geral, Cardiologia, Dermatologia, Psicologia e Pediatria.";
            }

            return "ü§ñ N√£o entendi sua pergunta m√©dica. Tente ser mais espec√≠fico ou use as salas de consulta üè•";
        }

        // Live Chat Functions (keeping original)
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                chatContainer.classList.add('open');
                if (!ws) {
                    initWebSocket();
                }
            } else {
                chatContainer.classList.remove('open');
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;

            const message = {
                text: text,
                userId: userId,
                timestamp: Date.now(),
                userName: 'Voc√™',
                type: 'text'
            };

            displayMessage(message, true);
            
            if (firebaseConnected && messagesRef) {
                messagesRef.push(message).catch((error) => {
                    console.error('Erro ao enviar mensagem:', error);
                    addSystemMessage('‚ùå Erro ao enviar mensagem');
                });
            }
            
            playSendSound();
            input.value = '';
            updateMainButton();
        }

        function handleMainAction() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (text) {
                sendMessage();
            } else {
                toggleRecording();
            }
        }

        function updateMainButton() {
            const messageInput = document.getElementById('messageInput');
            const mainActionIcon = document.getElementById('mainActionIcon');
            const mainActionBtn = document.getElementById('mainActionBtn');
            const text = messageInput.value.trim();
            
            if (isRecording) {
                mainActionIcon.textContent = '‚èπÔ∏è';
                mainActionBtn.className = 'bg-red-600 w-12 h-12 rounded-full hover:bg-red-700 transition flex-shrink-0 flex items-center justify-center recording';
            } else if (text) {
                mainActionIcon.textContent = 'üì§';
                mainActionBtn.className = 'bg-blue-600 w-12 h-12 rounded-full hover:bg-blue-700 transition flex-shrink-0 flex items-center justify-center';
            } else {
                mainActionIcon.textContent = 'üé§';
                mainActionBtn.className = 'bg-green-600 w-12 h-12 rounded-full hover:bg-green-700 transition flex-shrink-0 flex items-center justify-center';
            }
        }

        function displayMessage(message, isSent) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isSent ? 'ml-auto bg-blue-600' : 'bg-gray-700'} p-3 rounded-xl max-w-xs`;
            
            let content = '';
            
            if (message.type === 'image') {
                content = `<img src="${message.imageData}" class="max-w-full rounded-lg mb-2">`;
            } else if (message.type === 'audio') {
                const audioId = 'audio_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const mimeType = message.mimeType || 'audio/webm';
                
                content = `
                    <div class="audio-message bg-gray-600 rounded-lg p-3 mb-2">
                        <div class="flex items-center space-x-3">
                            <button onclick="toggleAudioPlayback('${audioId}')" class="bg-blue-500 hover:bg-blue-600 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <span id="playIcon_${audioId}">‚ñ∂Ô∏è</span>
                            </button>
                            <div class="flex-1">
                                <div class="bg-gray-700 rounded-full h-2 mb-1">
                                    <div id="progress_${audioId}" class="bg-blue-500 h-2 rounded-full transition-all duration-100" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-400">
                                    <span id="currentTime_${audioId}">0:00</span>
                                    <span id="duration_${audioId}">0:00</span>
                                </div>
                            </div>
                        </div>
                        <audio id="${audioId}" preload="auto" style="display: none;">
                            <source src="${message.audioData}" type="${mimeType}">
                        </audio>
                    </div>
                `;
            } else {
                content = `<p class="text-sm">${message.text}</p>`;
            }
            
            const time = new Date(message.timestamp).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                ${content}
                <span class="text-xs text-gray-400">${message.userName} ‚Ä¢ ${time}</span>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function addSystemMessage(text) {
            const messagesArea = document.getElementById('messagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble bg-yellow-900 bg-opacity-50 p-3 rounded-xl max-w-xs mx-auto text-center';
            messageDiv.innerHTML = `<p class="text-sm text-yellow-200">${text}</p>`;
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        async function toggleRecording() {
            const micStatus = document.getElementById('micStatus');
            
            if (!isRecording) {
                try {
                    const constraints = {
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 44100,
                            channelCount: 1
                        }
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    let options = { audioBitsPerSecond: 96000 };
                    
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        options.mimeType = 'audio/webm;codecs=opus';
                    } else if (MediaRecorder.isTypeSupported('audio/webm')) {
                        options.mimeType = 'audio/webm';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        options.mimeType = 'audio/mp4';
                    }
                    
                    mediaRecorder = new MediaRecorder(stream, options);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data && event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        try {
                            const mimeType = mediaRecorder.mimeType || 'audio/webm';
                            const audioBlob = new Blob(audioChunks, { type: mimeType });
                            
                            if (audioBlob.size === 0) {
                                throw new Error('√Åudio vazio gravado');
                            }
                            
                            const audioUrl = URL.createObjectURL(audioBlob);
                            
                            const message = {
                                audioData: audioUrl,
                                mimeType: mimeType,
                                userId: userId,
                                timestamp: Date.now(),
                                userName: 'Voc√™',
                                type: 'audio'
                            };
                            
                            displayMessage(message, true);
                            
                            if (firebaseConnected && messagesRef) {
                                const reader = new FileReader();
                                reader.onload = () => {
                                    const firebaseMessage = {
                                        audioData: reader.result,
                                        mimeType: mimeType,
                                        userId: userId,
                                        timestamp: message.timestamp,
                                        userName: 'Voc√™',
                                        type: 'audio'
                                    };
                                    messagesRef.push(firebaseMessage).catch(console.error);
                                };
                                reader.readAsDataURL(audioBlob);
                            }
                            
                            playSendSound();
                            
                        } catch (error) {
                            console.error('Erro ao processar √°udio:', error);
                            addSystemMessage('‚ùå Erro ao processar √°udio gravado');
                        }
                    };
                    
                    mediaRecorder.onerror = (event) => {
                        console.error('Erro na grava√ß√£o:', event.error);
                        addSystemMessage('‚ùå Erro durante a grava√ß√£o');
                        resetRecordingState();
                    };
                    
                    mediaRecorder.start(250);
                    isRecording = true;
                    micStatus.classList.remove('hidden');
                    updateMainButton();
                    
                    setTimeout(() => {
                        if (isRecording) {
                            toggleRecording();
                        }
                    }, 60000);
                    
                } catch (error) {
                    console.error('Erro ao acessar microfone:', error);
                    
                    let errorMessage = 'üé§ Erro ao acessar microfone!';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'üé§ Permiss√£o negada!\n\nClique no √≠cone de microfone na barra de endere√ßos e selecione "Permitir"';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'üé§ Microfone n√£o encontrado!\n\nVerifique se est√° conectado e funcionando';
                    }
                    
                    alert(errorMessage);
                    resetRecordingState();
                }
            } else {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                resetRecordingState();
            }
        }

        function resetRecordingState() {
            isRecording = false;
            document.getElementById('micStatus').classList.add('hidden');
            updateMainButton();
            
            if (mediaRecorder && mediaRecorder.stream) {
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        function sendImage() {
            const input = document.getElementById('imageInput');
            const file = input.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = () => {
                const imageData = reader.result;
                const message = {
                    imageData: imageData,
                    userId: userId,
                    timestamp: Date.now(),
                    userName: 'Voc√™',
                    type: 'image'
                };
                
                displayMessage(message, true);
                
                if (firebaseConnected && messagesRef) {
                    messagesRef.push(message).catch((error) => {
                        console.error('Erro ao enviar imagem:', error);
                    });
                }
                
                playSendSound();
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function playSendSound() {
            playNotificationSound('send');
            // Fallback to HTML audio if available
            const audio = document.getElementById('sendSound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }

        function playReceiveSound() {
            playNotificationSound('receive');
            // Fallback to HTML audio if available
            const audio = document.getElementById('receiveSound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }

        function bookConsultation(service, price) {
            const message = `Ol√°! Gostaria de agendar uma consulta de *${service}* por R$ ${price}. Quando h√° disponibilidade?`;
            const whatsappUrl = `https://wa.me/5511999999999?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showNotification('Redirecionando...', `Agendando consulta de ${service}`, 'info');
        }

        function scrollToServices() {
            document.getElementById('services').scrollIntoView({ behavior: 'smooth' });
        }

        function toggleAudioPlayback(audioId) {
            const audio = document.getElementById(audioId);
            const playIcon = document.getElementById(`playIcon_${audioId}`);
            const progressBar = document.getElementById(`progress_${audioId}`);
            const currentTimeSpan = document.getElementById(`currentTime_${audioId}`);
            const durationSpan = document.getElementById(`duration_${audioId}`);
            
            if (!audio) return;
            
            if (audio.paused) {
                document.querySelectorAll('audio').forEach(otherAudio => {
                    if (otherAudio !== audio && !otherAudio.paused) {
                        otherAudio.pause();
                        const otherId = otherAudio.id;
                        const otherIcon = document.getElementById(`playIcon_${otherId}`);
                        if (otherIcon) otherIcon.textContent = '‚ñ∂Ô∏è';
                    }
                });
                
                audio.play().then(() => {
                    playIcon.textContent = '‚è∏Ô∏è';
                }).catch(error => {
                    console.error('Erro ao reproduzir √°udio:', error);
                    playIcon.textContent = '‚ùå';
                });
            } else {
                audio.pause();
                playIcon.textContent = '‚ñ∂Ô∏è';
            }
            
            if (!audio.hasEventListeners) {
                audio.addEventListener('loadedmetadata', () => {
                    durationSpan.textContent = formatTime(audio.duration);
                });
                
                audio.addEventListener('timeupdate', () => {
                    if (audio.duration) {
                        const progress = (audio.currentTime / audio.duration) * 100;
                        progressBar.style.width = progress + '%';
                        currentTimeSpan.textContent = formatTime(audio.currentTime);
                    }
                });
                
                audio.addEventListener('ended', () => {
                    playIcon.textContent = '‚ñ∂Ô∏è';
                    progressBar.style.width = '0%';
                    currentTimeSpan.textContent = '0:00';
                    audio.currentTime = 0;
                });
                
                audio.addEventListener('error', (e) => {
                    console.error('Erro no √°udio:', e);
                    playIcon.textContent = '‚ùå';
                });
                
                audio.hasEventListeners = true;
            }
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Event Listeners
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleMainAction();
            }
        });

        document.getElementById('autoMessageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendAutoMessage();
            }
        });

        document.getElementById('roomMessageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendRoomMessage();
            }
        });

        document.getElementById('messageInput').addEventListener('input', updateMainButton);



        // Pharmacy Finder Functions
        function togglePharmacyFinder() {
            const pharmacyContainer = document.getElementById('pharmacyContainer');
            pharmacyOpen = !pharmacyOpen;
            
            if (pharmacyOpen) {
                pharmacyContainer.classList.add('open');
                showNotification('Farm√°cias PE!', 'Encontre farm√°cias em Pernambuco', 'info');
            } else {
                pharmacyContainer.classList.remove('open');
            }
        }

        // New location functions
        function useCurrentLocation() {
            showNotification('Localizando...', 'Buscando sua localiza√ß√£o atual', 'info');
            
            if (!navigator.geolocation) {
                showNotification('Erro!', 'Geolocaliza√ß√£o n√£o suportada pelo navegador', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    document.getElementById('locationInput').value = `üìç Localiza√ß√£o atual (${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)})`;
                    
                    await initializeMap();
                    await searchNearbyPharmacies(userLocation);
                },
                (error) => {
                    console.error('Erro de geolocaliza√ß√£o:', error);
                    
                    let errorMessage = 'Erro ao obter localiza√ß√£o';
                    if (error.code === 1) {
                        errorMessage = 'Permiss√£o de localiza√ß√£o negada';
                    } else if (error.code === 2) {
                        errorMessage = 'Localiza√ß√£o indispon√≠vel';
                    } else if (error.code === 3) {
                        errorMessage = 'Tempo limite excedido';
                    }
                    
                    showNotification('Erro!', errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        async function searchByAddress() {
            const locationInput = document.getElementById('locationInput');
            const address = locationInput.value.trim();
            
            if (!address) {
                showNotification('Aten√ß√£o!', 'Digite um endere√ßo de Caruaru-PE', 'warning');
                return;
            }
            
            showNotification('Buscando...', `Procurando em Caruaru: ${address}`, 'info');
            
            try {
                // Geocodifica√ß√£o espec√≠fica para Caruaru
                const coordinates = await geocodeCaruaruAddress(address);
                
                if (coordinates) {
                    userLocation = coordinates;
                    locationInput.value = `üìç ${address} - Caruaru, PE`;
                    
                    await initializeMap();
                    await searchNearbyPharmacies(userLocation);
                    
                    showNotification('Encontrado!', 'Localiza√ß√£o em Caruaru confirmada', 'success');
                } else {
                    showNotification('N√£o encontrado!', 'Digite um endere√ßo v√°lido de Caruaru-PE', 'warning');
                    // Sugerir Caruaru como padr√£o
                    userLocation = { lat: -8.2837, lng: -35.9761 };
                    locationInput.value = 'üìç Centro de Caruaru, PE';
                    await initializeMap();
                    await searchNearbyPharmacies(userLocation);
                }
            } catch (error) {
                console.error('Erro ao buscar endere√ßo:', error);
                showNotification('Erro!', 'Usando localiza√ß√£o padr√£o de Caruaru', 'info');
                // Fallback para centro de Caruaru
                userLocation = { lat: -8.2837, lng: -35.9761 };
                locationInput.value = 'üìç Centro de Caruaru, PE';
                await initializeMap();
                await searchNearbyPharmacies(userLocation);
            }
        }

        async function geocodeCaruaruAddress(address) {
            // Coordenadas espec√≠ficas de Caruaru e bairros
            const caruaruLocations = {
                'centro': { lat: -8.2837, lng: -35.9761 },
                'universitario': { lat: -8.2650, lng: -35.9550 },
                'mauricio de nassau': { lat: -8.2900, lng: -35.9800 },
                'kennedy': { lat: -8.2700, lng: -35.9900 },
                'nova caruaru': { lat: -8.2600, lng: -35.9600 },
                'indianopolis': { lat: -8.2950, lng: -35.9650 },
                'petropolis': { lat: -8.2750, lng: -35.9850 },
                'salgado': { lat: -8.2550, lng: -35.9450 },
                'cedro': { lat: -8.2400, lng: -35.9300 },
                'vassoural': { lat: -8.3000, lng: -35.9900 },
                'rendeiras': { lat: -8.2500, lng: -35.9200 },
                'boa vista': { lat: -8.2800, lng: -36.0000 }
            };
            
            const normalizedAddress = address.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/g, '');
            
            // Buscar por bairros espec√≠ficos de Caruaru
            for (const [bairro, coords] of Object.entries(caruaruLocations)) {
                if (normalizedAddress.includes(bairro)) {
                    return coords;
                }
            }
            
            // Se mencionar Caruaru
            if (normalizedAddress.includes('caruaru')) {
                return caruaruLocations.centro;
            }
            
            // CEPs de Caruaru (55000-000 a 55299-999)
            const cepMatch = address.match(/55[0-2]\d{2}-?\d{3}/);
            if (cepMatch) {
                return caruaruLocations.centro;
            }
            
            // Ruas conhecidas de Caruaru
            const caruaruStreets = [
                'agamenon magalhaes', 'vigario freire', 'adjar da silva case',
                'sete de setembro', 'rio branco', 'coronel jose carvalho',
                'quinze de novembro', 'treze de maio', 'joao pessoa'
            ];
            
            for (const street of caruaruStreets) {
                if (normalizedAddress.includes(street)) {
                    return caruaruLocations.centro;
                }
            }
            
            return null;
        }



        function clickOnMap() {
            showNotification('Modo mapa!', 'Clique no mapa para selecionar sua localiza√ß√£o', 'info');
            
            // Inicializar mapa interativo
            initializeInteractiveMap();
        }

        function initializeInteractiveMap() {
            const mapContainer = document.getElementById('map');
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            
            mapPlaceholder.style.display = 'none';
            
            // Criar mapa interativo clic√°vel
            mapContainer.innerHTML = `
                <div class="w-full h-full bg-gray-700 rounded-lg relative overflow-hidden" onclick="selectLocationOnMap(event)">
                    <!-- Fundo do mapa -->
                    <div class="absolute inset-0 bg-gradient-to-br from-green-600 via-blue-600 to-purple-600 opacity-30"></div>
                    
                    <!-- Grid do mapa -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="grid grid-cols-10 grid-rows-8 h-full">
                            ${Array(80).fill().map(() => '<div class="border border-gray-400"></div>').join('')}
                        </div>
                    </div>
                    
                    <!-- Instru√ß√µes -->
                    <div class="absolute top-2 left-2 bg-black bg-opacity-70 rounded px-3 py-2 z-20">
                        <p class="text-xs text-white">üñ±Ô∏è Clique para selecionar sua localiza√ß√£o</p>
                    </div>
                    
                    <!-- Marcador de sele√ß√£o (inicialmente oculto) -->
                    <div id="selectedLocationMarker" class="absolute z-20 hidden">
                        <div class="bg-red-500 w-4 h-4 rounded-full border-2 border-white shadow-lg animate-pulse"></div>
                        <div class="text-xs text-white font-semibold mt-1 text-center whitespace-nowrap">Selecionado</div>
                    </div>
                    
                    <!-- Coordenadas -->
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-70 rounded px-2 py-1 z-20">
                        <p id="mapCoordinates" class="text-xs text-white">Clique no mapa</p>
                    </div>
                </div>
            `;
        }

        function selectLocationOnMap(event) {
            const mapContainer = event.currentTarget;
            const rect = mapContainer.getBoundingClientRect();
            
            // Calcular posi√ß√£o relativa do clique
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Converter para coordenadas (simula√ß√£o)
            // S√£o Paulo como centro: -23.5505, -46.6333
            const lat = -23.5505 - ((y / rect.height - 0.5) * 0.2); // ¬±0.1 grau
            const lng = -46.6333 + ((x / rect.width - 0.5) * 0.2); // ¬±0.1 grau
            
            userLocation = { lat, lng };
            
            // Mostrar marcador na posi√ß√£o clicada
            const marker = document.getElementById('selectedLocationMarker');
            marker.style.left = (x - 8) + 'px'; // -8 para centralizar o marcador
            marker.style.top = (y - 8) + 'px';
            marker.classList.remove('hidden');
            
            // Atualizar coordenadas
            document.getElementById('mapCoordinates').textContent = `üìç ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            
            // Atualizar input de localiza√ß√£o
            document.getElementById('locationInput').value = `üìç Localiza√ß√£o selecionada (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
            
            // Buscar farm√°cias pr√≥ximas
            searchNearbyPharmacies(userLocation);
            
            showNotification('Localiza√ß√£o selecionada!', 'Buscando farm√°cias pr√≥ximas', 'success');
        }

        async function findNearbyPharmacies() {
            if (!userLocation) {
                showNotification('Aten√ß√£o!', 'Primeiro selecione sua localiza√ß√£o', 'warning');
                return;
            }
            
            await searchNearbyPharmacies(userLocation);
        }

        async function initializeMap() {
            const mapContainer = document.getElementById('map');
            const mapPlaceholder = document.getElementById('mapPlaceholder');
            
            mapPlaceholder.style.display = 'none';
            
            // Criar mapa visual com farm√°cias
            mapContainer.innerHTML = `
                <div class="w-full h-full bg-gray-700 rounded-lg relative overflow-hidden">
                    <!-- Fundo do mapa -->
                    <div class="absolute inset-0 bg-gradient-to-br from-green-600 via-blue-600 to-purple-600 opacity-30"></div>
                    
                    <!-- Grid do mapa -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="grid grid-cols-8 grid-rows-6 h-full">
                            ${Array(48).fill().map(() => '<div class="border border-gray-400"></div>').join('')}
                        </div>
                    </div>
                    
                    <!-- Sua localiza√ß√£o (centro) -->
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20">
                        <div class="bg-blue-500 w-4 h-4 rounded-full border-2 border-white shadow-lg animate-pulse"></div>
                        <div class="text-xs text-white font-semibold mt-1 text-center whitespace-nowrap">Voc√™</div>
                    </div>
                    
                    <!-- Farm√°cias pr√≥ximas -->
                    <div class="absolute top-1/4 left-1/3 z-10">
                        <div class="bg-red-500 w-3 h-3 rounded-full border border-white"></div>
                        <div class="text-xs text-white mt-1">üè™</div>
                    </div>
                    
                    <div class="absolute top-3/4 left-2/3 z-10">
                        <div class="bg-red-500 w-3 h-3 rounded-full border border-white"></div>
                        <div class="text-xs text-white mt-1">üè™</div>
                    </div>
                    
                    <div class="absolute top-1/3 left-3/4 z-10">
                        <div class="bg-red-500 w-3 h-3 rounded-full border border-white"></div>
                        <div class="text-xs text-white mt-1">üè™</div>
                    </div>
                    
                    <div class="absolute top-2/3 left-1/4 z-10">
                        <div class="bg-red-500 w-3 h-3 rounded-full border border-white"></div>
                        <div class="text-xs text-white mt-1">üè™</div>
                    </div>
                    
                    <!-- Info da localiza√ß√£o -->
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-50 rounded px-2 py-1 z-20">
                        <p class="text-xs text-white">üìç ${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}</p>
                    </div>
                </div>
            `;
        }

        async function searchNearbyPharmacies(location) {
            try {
                showNotification('Buscando...', 'Procurando farm√°cias pr√≥ximas', 'info');
                
                // Tentar buscar farm√°cias reais usando API p√∫blica
                let pharmacies = [];
                
                try {
                    // Usar Overpass API (OpenStreetMap) para buscar farm√°cias reais
                    const overpassQuery = `
                        [out:json][timeout:10];
                        (
                          node["amenity"="pharmacy"](around:5000,${location.lat},${location.lng});
                          way["amenity"="pharmacy"](around:5000,${location.lat},${location.lng});
                          relation["amenity"="pharmacy"](around:5000,${location.lat},${location.lng});
                        );
                        out center meta;
                    `;
                    
                    const overpassUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`;
                    
                    console.log('üîç Buscando farm√°cias reais via Overpass API...');
                    
                    const response = await fetch(overpassUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Dados recebidos da Overpass API:', data.elements?.length || 0, 'farm√°cias');
                        
                        if (data.elements && data.elements.length > 0) {
                            pharmacies = data.elements.slice(0, 10).map((element, index) => {
                                const lat = element.lat || element.center?.lat || location.lat;
                                const lng = element.lon || element.center?.lon || location.lng;
                                const distance = calculateDistance(location.lat, location.lng, lat, lng);
                                
                                return {
                                    id: element.id || index,
                                    name: element.tags?.name || element.tags?.brand || `Farm√°cia ${index + 1}`,
                                    address: formatAddress(element.tags),
                                    distance: distance.toFixed(1),
                                    rating: (Math.random() * 1.5 + 3.5).toFixed(1),
                                    phone: generateRealisticPhone(location),
                                    hours: element.tags?.opening_hours || (Math.random() > 0.3 ? '08:00 - 22:00' : '24 horas'),
                                    services: getPharmacyServices(element.tags),
                                    lat: lat,
                                    lng: lng,
                                    isOpen: !element.tags?.opening_hours || Math.random() > 0.2,
                                    hasDelivery: Math.random() > 0.4,
                                    acceptsInsurance: Math.random() > 0.3,
                                    isReal: true
                                };
                            });
                        }
                    }
                } catch (apiError) {
                    console.warn('‚ö†Ô∏è Erro na API Overpass:', apiError.message);
                }
                
                // Se n√£o conseguiu dados reais, usar dados demo
                if (pharmacies.length === 0) {
                    console.log('üìã Usando dados demo como fallback');
                    pharmacies = generateDemoPharmacies(location);
                }
                
                displayPharmacyResults(pharmacies);
                
                const realCount = pharmacies.filter(p => p.isReal).length;
                const message = realCount > 0 ? 
                    `${realCount} farm√°cias reais encontradas!` : 
                    `${pharmacies.length} farm√°cias pr√≥ximas (demo)`;
                
                showNotification('Encontradas!', message, 'success');
                
            } catch (error) {
                console.error('Erro ao buscar farm√°cias:', error);
                showNotification('Erro!', 'N√£o foi poss√≠vel buscar farm√°cias', 'error');
            }
        }

        // Fun√ß√µes auxiliares para API de farm√°cias
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function formatAddress(tags) {
            if (!tags) return 'Endere√ßo n√£o dispon√≠vel';
            
            const parts = [];
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
            if (tags['addr:neighbourhood']) parts.push(tags['addr:neighbourhood']);
            if (tags['addr:city']) parts.push(tags['addr:city']);
            
            return parts.length > 0 ? parts.join(', ') : 'Endere√ßo n√£o dispon√≠vel';
        }
        
        function getPharmacyServices(tags) {
            const services = [];
            
            if (tags?.dispensing === 'yes') services.push('Medicamentos com receita');
            if (tags?.wheelchair === 'yes') services.push('Acess√≠vel');
            if (tags?.opening_hours?.includes('24/7')) services.push('24 horas');
            if (tags?.phone) services.push('Atendimento telef√¥nico');
            if (tags?.website) services.push('Site pr√≥prio');
            
            // Adicionar servi√ßos padr√£o se n√£o houver informa√ß√µes espec√≠ficas
            if (services.length === 0) {
                const defaultServices = [
                    'Medicamentos gerais', 'Produtos de higiene', 'Cosm√©ticos',
                    'Medi√ß√£o de press√£o', 'Aplica√ß√£o de inje√ß√µes'
                ];
                services.push(...defaultServices.slice(0, 3));
            }
            
            return services;
        }

        function generateRealisticAddress(location, index) {
            // Ruas t√≠picas por regi√£o
            const streetsByRegion = {
                'sao_paulo': [
                    'Rua Augusta', 'Av. Paulista', 'Rua Oscar Freire', 'Rua da Consola√ß√£o', 'Av. Faria Lima',
                    'Rua Teodoro Sampaio', 'Av. Rebou√ßas', 'Rua Haddock Lobo', 'Av. Brigadeiro Lu√≠s Ant√¥nio'
                ],
                'rio_janeiro': [
                    'Av. Copacabana', 'Rua Barata Ribeiro', 'Av. Atl√¢ntica', 'Rua Visconde de Piraj√°',
                    'Av. Nossa Senhora de Copacabana', 'Rua General Os√≥rio', 'Av. Prado J√∫nior'
                ],
                'belo_horizonte': [
                    'Av. Afonso Pena', 'Rua da Bahia', 'Av. Amazonas', 'Rua Tupis', 'Av. do Contorno',
                    'Rua Curitiba', 'Av. Brasil', 'Rua Esp√≠rito Santo'
                ],
                'brasilia': [
                    'SQN 102', 'SQS 308', 'CLN 204', 'CLS 405', 'W3 Norte', 'W3 Sul', 'Asa Norte', 'Asa Sul'
                ],
                'salvador': [
                    'Av. Sete de Setembro', 'Rua Chile', 'Av. Oce√¢nica', 'Rua Carlos Gomes',
                    'Av. Ant√¥nio Carlos Magalh√£es', 'Rua da Paci√™ncia'
                ],
                'fortaleza': [
                    'Av. Beira Mar', 'Rua Major Facundo', 'Av. Dom Lu√≠s', 'Rua Bar√£o do Rio Branco',
                    'Av. Santos Dumont', 'Rua Senador Pompeu'
                ],
                'recife': [
                    'Av. Boa Viagem', 'Rua do Hosp√≠cio', 'Av. Conde da Boa Vista', 'Rua da Aurora',
                    'Av. Agamenon Magalh√£es', 'Rua Benfica'
                ],
                'porto_alegre': [
                    'Av. Borges de Medeiros', 'Rua da Praia', 'Av. Osvaldo Aranha', 'Rua Volunt√°rios da P√°tria',
                    'Av. Ipiranga', 'Rua Sarmento Leite'
                ],
                'curitiba': [
                    'Rua XV de Novembro', 'Av. C√¢ndido de Abreu', 'Rua Marechal Deodoro', 'Av. Batel',
                    'Rua Comendador Ara√∫jo', 'Av. Paran√°'
                ],
                'default': [
                    'Rua das Flores', 'Av. Principal', 'Rua do Com√©rcio', 'Rua Central', 'Av. da Sa√∫de',
                    'Rua S√£o Jo√£o', 'Av. Brasil', 'Rua Quinze de Novembro'
                ]
            };
            
            // Determinar regi√£o baseada na localiza√ß√£o
            let streets = streetsByRegion.default;
            
            if (location.lat > -20 && location.lat < -19 && location.lng > -44 && location.lng < -43) {
                streets = streetsByRegion.belo_horizonte;
            } else if (location.lat > -23 && location.lat < -22 && location.lng > -44 && location.lng < -43) {
                streets = streetsByRegion.rio_janeiro;
            } else if (location.lat > -16 && location.lat < -15 && location.lng > -48 && location.lng < -47) {
                streets = streetsByRegion.brasilia;
            } else if (location.lat > -13 && location.lat < -12 && location.lng > -39 && location.lng < -38) {
                streets = streetsByRegion.salvador;
            } else if (location.lat > -4 && location.lat < -3 && location.lng > -39 && location.lng < -38) {
                streets = streetsByRegion.fortaleza;
            } else if (location.lat > -9 && location.lat < -8 && location.lng > -35 && location.lng < -34) {
                streets = streetsByRegion.recife;
            } else if (location.lat > -31 && location.lat < -30 && location.lng > -52 && location.lng < -51) {
                streets = streetsByRegion.porto_alegre;
            } else if (location.lat > -26 && location.lat < -25 && location.lng > -50 && location.lng < -49) {
                streets = streetsByRegion.curitiba;
            } else if (location.lat > -24 && location.lat < -23 && location.lng > -47 && location.lng < -46) {
                streets = streetsByRegion.sao_paulo;
            }
            
            const street = streets[Math.floor(Math.random() * streets.length)];
            const number = Math.floor(Math.random() * 2000) + 100;
            
            return `${street}, ${number}`;
        }

        function generateCaruaruAddress(location, index) {
            // Ruas e avenidas espec√≠ficas de Caruaru
            const caruaruStreets = [
                'Av. Agamenon Magalh√£es', 'Rua Vig√°rio Freire', 'Av. Adjar da Silva Cas√©',
                'Rua Sete de Setembro', 'Av. Rio Branco', 'Rua Coronel Jos√© Carvalho',
                'Av. Jos√© Rodrigues de Jesus', 'Rua Quinze de Novembro', 'Av. Portugal',
                'Rua Treze de Maio', 'Av. Oscar Laranjeira', 'Rua Jo√£o Pessoa',
                'Av. Universit√°ria', 'Rua Padre Carapuceiro', 'Av. Maur√≠cio de Nassau',
                'Rua Bar√£o do Rio Branco', 'Av. Central', 'Rua Dom Pedro II',
                'Av. Cleto Campelo', 'Rua Jos√© Mariano'
            ];
            
            const street = caruaruStreets[Math.floor(Math.random() * caruaruStreets.length)];
            const number = Math.floor(Math.random() * 2000) + 100;
            
            // Bairros espec√≠ficos de Caruaru
            const caruaruNeighborhoods = [
                'Centro', 'Universit√°rio', 'Maur√≠cio de Nassau', 'Petr√≥polis',
                'Indian√≥polis', 'Nova Caruaru', 'Kennedy', 'Salgado',
                'Cedro', 'Vassoural', 'Alto do Moura', 'Rendeiras',
                'Boa Vista', 'S√£o Francisco', 'Riach√£o', 'Caiuc√°'
            ];
            
            const neighborhood = caruaruNeighborhoods[Math.floor(Math.random() * caruaruNeighborhoods.length)];
            
            return `${street}, ${number} - ${neighborhood}, Caruaru-PE`;
        }



        function generatePernambucoPhone(location) {
            // C√≥digos de √°rea espec√≠ficos de Pernambuco
            const pernambucoCodes = ['81', '87'];
            
            const areaCode = pernambucoCodes[Math.floor(Math.random() * pernambucoCodes.length)];
            const number = Math.floor(Math.random() * 90000000) + 10000000; // 8 d√≠gitos
            const formattedNumber = number.toString().replace(/(\d{4})(\d{4})/, '$1-$2');
            
            return `(${areaCode}) 9${formattedNumber}`;
        }

        function generateRealisticPhone(location) {
            // Para compatibilidade, usar fun√ß√£o espec√≠fica de PE
            return generatePernambucoPhone(location);
        }

        function generateDemoPharmacies(location) {
            // Farm√°cias espec√≠ficas de Caruaru - PE
            const caruaruPharmacies = [
                { name: 'Farm√°cia Pague Menos Caruaru', chain: true },
                { name: 'Drogasil Centro', chain: true },
                { name: 'Farm√°cia S√£o Jo√£o', chain: false },
                { name: 'Drogaria Ros√°rio', chain: false },
                { name: 'Farm√°cia Popular Caruaru', chain: true },
                { name: 'Drogaria Universit√°rio', chain: false },
                { name: 'Farm√°cia Santa Clara', chain: false },
                { name: 'Drogaria Kennedy', chain: false },
                { name: 'Farm√°cia Central Caruaru', chain: false },
                { name: 'Drogaria Agreste', chain: false },
                { name: 'Farm√°cia Boa Sa√∫de', chain: false },
                { name: 'Drogaria Maur√≠cio de Nassau', chain: false }
            ];
            
            const services = [
                'Entrega em domic√≠lio', 'Farm√°cia 24h', 'Teste de COVID-19', 
                'Aplica√ß√£o de vacinas', 'Medi√ß√£o de press√£o', 'Teste de glicemia',
                'Perfumaria', 'Produtos naturais', 'Manipula√ß√£o', 'Frald√°rio',
                'Aferi√ß√£o de temperatura', 'Nebuliza√ß√£o'
            ];

            return caruaruPharmacies.slice(0, 10).map((pharmacy, index) => {
                // Gerar coordenadas pr√≥ximas (raio de ~5km)
                const latOffset = (Math.random() - 0.5) * 0.05;
                const lngOffset = (Math.random() - 0.5) * 0.05;
                
                const distance = Math.random() * 4 + 0.5; // 0.5 a 4.5 km
                const rating = (Math.random() * 1.5 + 3.5).toFixed(1); // 3.5 a 5.0
                
                const availableServices = services
                    .sort(() => Math.random() - 0.5)
                    .slice(0, Math.floor(Math.random() * 4) + 2);

                return {
                    id: index + 1,
                    name: pharmacy.name,
                    address: generateCaruaruAddress(location, index),
                    distance: distance.toFixed(1),
                    rating: rating,
                    phone: generatePernambucoPhone(location),
                    hours: Math.random() > 0.3 ? '06:00 - 22:00' : '24 horas',
                    services: availableServices,
                    lat: location.lat + latOffset,
                    lng: location.lng + lngOffset,
                    isOpen: Math.random() > 0.15,
                    hasDelivery: Math.random() > 0.3,
                    acceptsInsurance: Math.random() > 0.2,
                    isChain: pharmacy.chain
                };
            });
        }

        function displayPharmacyResults(pharmacies) {
            const resultsContainer = document.getElementById('pharmacyResults');
            
            const realCount = pharmacies.filter(p => p.isReal).length;
            const statusText = realCount > 0 ? 
                `üìç ${realCount} farm√°cias reais + ${pharmacies.length - realCount} demo` : 
                `üìç ${pharmacies.length} farm√°cias pr√≥ximas (demo)`;
            
            let html = `
                <div class="mb-2 p-2 bg-orange-900 bg-opacity-30 rounded-lg border border-orange-500">
                    <h6 class="font-bold text-orange-300 text-center text-xs">${statusText}</h6>
                    <p class="text-xs text-orange-200 text-center mt-1">Clique para ligar, ver rota ou delivery</p>
                </div>
            `;
            
            pharmacies.forEach((pharmacy, index) => {
                const statusColor = pharmacy.isOpen ? 'text-green-400' : 'text-red-400';
                const statusText = pharmacy.isOpen ? 'üü¢' : 'üî¥';
                const deliveryBadge = pharmacy.hasDelivery ? 'üöö' : '';
                const insuranceBadge = pharmacy.acceptsInsurance ? 'üí≥' : '';
                const realBadge = pharmacy.isReal ? '‚úÖ' : 'üîÑ';
                
                html += `
                    <div class="bg-gray-800 rounded-lg p-2 border border-gray-600 hover:border-orange-500 transition mb-1 shadow-lg">
                        <!-- Cabe√ßalho Compacto -->
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex-1 min-w-0">
                                <h7 class="font-bold text-white text-xs truncate block">${pharmacy.name}</h7>
                                <div class="flex items-center space-x-1 mt-1">
                                    <span class="${statusColor} text-xs">${statusText}</span>
                                    <span class="text-yellow-400 text-xs">‚≠ê${pharmacy.rating}</span>
                                    <span class="text-gray-400 text-xs">${pharmacy.distance}km</span>
                                    ${deliveryBadge ? `<span class="text-purple-400 text-xs">${deliveryBadge}</span>` : ''}
                                    ${insuranceBadge ? `<span class="text-blue-400 text-xs">${insuranceBadge}</span>` : ''}
                                    <span class="text-xs" title="${pharmacy.isReal ? 'Farm√°cia real' : 'Dados demo'}">${realBadge}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Endere√ßo Compacto -->
                        <div class="text-xs text-gray-300 mb-1 truncate">
                            üìç ${pharmacy.address}
                        </div>
                        
                        <!-- Telefone e Hor√°rio -->
                        <div class="flex justify-between text-xs text-gray-400 mb-2">
                            <span class="font-mono truncate">üìû ${pharmacy.phone}</span>
                            <span class="text-orange-400">üïí ${pharmacy.hours}</span>
                        </div>
                        
                        <!-- Bot√µes Compactos -->
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="callPharmacy('${pharmacy.phone}')" class="bg-green-600 hover:bg-green-700 py-1 px-1 rounded text-xs font-semibold transition">
                                üìû
                            </button>
                            <button onclick="getDirections(${pharmacy.lat}, ${pharmacy.lng})" class="bg-blue-600 hover:bg-blue-700 py-1 px-1 rounded text-xs font-semibold transition">
                                üó∫Ô∏è
                            </button>
                            ${pharmacy.hasDelivery ? 
                                `<button onclick="orderDelivery('${pharmacy.name}')" class="bg-purple-600 hover:bg-purple-700 py-1 px-1 rounded text-xs font-semibold transition">
                                    üöö
                                </button>` : 
                                `<button onclick="visitPharmacy('${pharmacy.name}', '${pharmacy.address}')" class="bg-gray-600 hover:bg-gray-700 py-1 px-1 rounded text-xs font-semibold transition">
                                    üí¨
                                </button>`
                            }
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }



        async function searchMedicineInPharmacies(medicine) {
            // Simular dados de medicamentos
            const commonMedicines = {
                'dipirona': { price: 'R$ 8,90', generic: true, prescription: false },
                'paracetamol': { price: 'R$ 6,50', generic: true, prescription: false },
                'ibuprofeno': { price: 'R$ 12,30', generic: true, prescription: false },
                'amoxicilina': { price: 'R$ 18,90', generic: true, prescription: true },
                'losartana': { price: 'R$ 15,60', generic: true, prescription: true },
                'sinvastatina': { price: 'R$ 22,40', generic: true, prescription: true },
                'omeprazol': { price: 'R$ 14,80', generic: true, prescription: false },
                'metformina': { price: 'R$ 11,20', generic: true, prescription: true }
            };
            
            const searchKey = medicine.toLowerCase();
            const medicineData = commonMedicines[searchKey] || {
                price: `R$ ${(Math.random() * 50 + 5).toFixed(2)}`,
                generic: Math.random() > 0.3,
                prescription: Math.random() > 0.5
            };
            
            // Gerar resultados para diferentes farm√°cias
            const pharmacyNames = ['Drogasil', 'Droga Raia', 'Pacheco', 'Ultrafarma', 'Drogaria S√£o Paulo'];
            
            return pharmacyNames.map((pharmacy, index) => {
                const basePrice = parseFloat(medicineData.price.replace('R$ ', ''));
                const variation = (Math.random() - 0.5) * 0.3; // ¬±30% de varia√ß√£o
                const finalPrice = (basePrice * (1 + variation)).toFixed(2);
                
                return {
                    pharmacy: pharmacy,
                    medicine: medicine,
                    price: `R$ ${finalPrice}`,
                    available: Math.random() > 0.2,
                    generic: medicineData.generic,
                    prescription: medicineData.prescription,
                    discount: Math.random() > 0.6 ? Math.floor(Math.random() * 20 + 5) : null,
                    delivery: Math.random() > 0.4,
                    distance: (Math.random() * 3 + 0.5).toFixed(1)
                };
            });
        }

        function displayMedicineResults(results, medicine) {
            const resultsContainer = document.getElementById('pharmacyResults');
            
            let html = `<h6 class="font-semibold mb-3 text-orange-300">üíä Resultados para "${medicine}"</h6>`;
            
            results.forEach(result => {
                const availabilityColor = result.available ? 'text-green-400' : 'text-red-400';
                const availabilityText = result.available ? 'Dispon√≠vel' : 'Indispon√≠vel';
                
                html += `
                    <div class="bg-gray-800 rounded-xl p-4 border border-gray-600 hover:border-orange-500 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h7 class="font-semibold text-white">${result.pharmacy}</h7>
                                <p class="text-sm text-gray-400">${result.distance} km de dist√¢ncia</p>
                            </div>
                            <span class="${availabilityColor} text-sm font-medium">${availabilityText}</span>
                        </div>
                        
                        <div class="space-y-1 text-sm mb-3">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Pre√ßo:</span>
                                <span class="text-green-400 font-semibold">${result.price}</span>
                            </div>
                            ${result.discount ? 
                                `<div class="flex justify-between">
                                    <span class="text-gray-300">Desconto:</span>
                                    <span class="text-orange-400">${result.discount}% OFF</span>
                                </div>` : ''
                            }
                        </div>
                        
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${result.generic ? '<span class="bg-blue-900 bg-opacity-50 text-blue-200 px-2 py-1 rounded-full text-xs">Gen√©rico</span>' : ''}
                            ${result.prescription ? '<span class="bg-red-900 bg-opacity-50 text-red-200 px-2 py-1 rounded-full text-xs">Receita</span>' : ''}
                            ${result.delivery ? '<span class="bg-purple-900 bg-opacity-50 text-purple-200 px-2 py-1 rounded-full text-xs">Delivery</span>' : ''}
                        </div>
                        
                        ${result.available ? `
                            <div class="flex space-x-2">
                                <button onclick="reserveMedicine('${result.pharmacy}', '${medicine}')" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2 px-3 rounded-lg text-sm transition">
                                    üìã Reservar
                                </button>
                                ${result.delivery ? 
                                    `<button onclick="orderMedicine('${result.pharmacy}', '${medicine}')" class="flex-1 bg-green-600 hover:bg-green-700 py-2 px-3 rounded-lg text-sm transition">
                                        üõí Comprar
                                    </button>` : ''
                                }
                            </div>
                        ` : `
                            <button class="w-full bg-gray-600 py-2 px-3 rounded-lg text-sm cursor-not-allowed" disabled>
                                ‚ùå Indispon√≠vel
                            </button>
                        `}
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            showNotification('Busca conclu√≠da!', `${results.filter(r => r.available).length} farm√°cias t√™m o medicamento`, 'success');
        }

        function callPharmacy(phone) {
            const cleanPhone = phone.replace(/\D/g, '');
            window.open(`tel:${cleanPhone}`, '_self');
            showNotification('Ligando...', `Conectando com ${phone}`, 'info');
        }

        function getDirections(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
            showNotification('Abrindo rota...', 'Redirecionando para Google Maps', 'info');
        }

        function orderDelivery(pharmacyName) {
            const message = `Ol√°! Gostaria de solicitar delivery da ${pharmacyName}. Podem me ajudar?`;
            const whatsappUrl = `https://wa.me/5511999999999?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showNotification('Delivery!', `Solicitando delivery da ${pharmacyName}`, 'success');
        }

        function reserveMedicine(pharmacy, medicine) {
            const message = `Ol√°! Gostaria de reservar o medicamento "${medicine}" na ${pharmacy}. Est√° dispon√≠vel?`;
            const whatsappUrl = `https://wa.me/5511999999999?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showNotification('Reservando...', `Medicamento ${medicine} na ${pharmacy}`, 'success');
        }

        function orderMedicine(pharmacy, medicine) {
            const message = `Ol√°! Gostaria de comprar "${medicine}" na ${pharmacy} com delivery. Qual o prazo de entrega?`;
            const whatsappUrl = `https://wa.me/5511999999999?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showNotification('Comprando...', `Pedido de ${medicine} enviado`, 'success');
        }

        function visitPharmacy(pharmacyName, address) {
            const message = `Ol√°! Gostaria de informa√ß√µes sobre a ${pharmacyName} localizada em ${address}. Voc√™s t√™m os medicamentos que preciso?`;
            const whatsappUrl = `https://wa.me/5511999999999?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showNotification('Contato!', `Entrando em contato com ${pharmacyName}`, 'info');
        }

        async function searchMedicine() {
            const searchInput = document.getElementById('medicineSearch');
            const medicine = searchInput.value.trim();
            
            if (!medicine) {
                showNotification('Aten√ß√£o!', 'Digite o nome do medicamento', 'warning');
                return;
            }
            
            if (!userLocation) {
                showNotification('Aten√ß√£o!', 'Primeiro selecione sua localiza√ß√£o', 'warning');
                return;
            }
            
            showNotification('Buscando...', `Procurando ${medicine}`, 'info');
            
            // Simular busca de medicamentos
            const results = await searchMedicineInPharmacies(medicine);
            displayMedicineResults(results, medicine);
        }

        // Event Listeners for Pharmacy Search
        document.addEventListener('DOMContentLoaded', () => {
            const medicineSearch = document.getElementById('medicineSearch');
            if (medicineSearch) {
                medicineSearch.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchMedicine();
                    }
                });
            }
            
            const locationInput = document.getElementById('locationInput');
            if (locationInput) {
                locationInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchByAddress();
                    }
                });
            }
        });

        // Nutrition Chat Functions
        let nutritionChatOpen = false;

        function toggleNutritionChat() {
            const nutritionChatContainer = document.getElementById('nutritionChatContainer');
            nutritionChatOpen = !nutritionChatOpen;
            
            if (nutritionChatOpen) {
                nutritionChatContainer.classList.add('open');
                showNotification('Nutricionista!', 'Dr. Nutricionista est√° online', 'success');
            } else {
                nutritionChatContainer.classList.remove('open');
            }
        }

        function closeNutritionChat() {
            const nutritionChatContainer = document.getElementById('nutritionChatContainer');
            nutritionChatOpen = false;
            nutritionChatContainer.classList.remove('open');
        }

        async function sendNutritionChatMessage() {
            const input = document.getElementById('nutritionMessageInput');
            const text = input.value.trim();
            
            if (!text) return;

            // Adicionar mensagem do usu√°rio
            addNutritionChatMessage(text, true, 'Voc√™');
            input.value = '';

            // Mostrar indicador de digita√ß√£o
            const typingId = addNutritionTypingIndicator();

            try {
                // Chamar IA Gemini para resposta da nutricionista
                const response = await getNutritionistAIResponse(text);
                removeNutritionTypingIndicator(typingId);
                addNutritionChatMessage(response, false, 'Dr. Nutricionista');
                
            } catch (error) {
                removeNutritionTypingIndicator(typingId);
                console.error('Erro na IA Gemini:', error);
                
                // Resposta de fallback
                const fallbackResponse = getNutritionFallbackResponse(text);
                addNutritionChatMessage(fallbackResponse, false, 'Dr. Nutricionista');
            }
        }

        async function getNutritionistAIResponse(message) {
            if (!isGeminiConfigured()) {
                throw new Error('API n√£o configurada');
            }

            const prompt = `Voc√™ √© Dra. Ana, uma nutricionista experiente e emp√°tica com 15 anos de experi√™ncia.

INSTRU√á√ïES:
- Responda como uma nutricionista profissional
- Use linguagem acess√≠vel e acolhedora
- Forne√ßa orienta√ß√µes nutricionais espec√≠ficas e pr√°ticas
- Inclua dicas de alimenta√ß√£o saud√°vel
- Sugira receitas quando apropriado
- Seja encorajadora e motivacional
- Limite sua resposta a 150 palavras
- Use portugu√™s brasileiro
- Sempre inclua disclaimer sobre consulta presencial quando necess√°rio

PERGUNTA DO PACIENTE: "${message}"

Responda como Dra. Ana, nutricionista:`;

            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    maxOutputTokens: 250,
                    temperature: 0.4,
                    topP: 0.8,
                    topK: 40
                }
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`Erro da API: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Resposta inv√°lida da API');
            }
        }

        function addNutritionChatMessage(text, isUser, sender) {
            const messagesArea = document.getElementById('nutritionMessagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'ml-auto bg-green-600' : 'bg-gray-700'} p-3 rounded-xl max-w-xs`;
            
            const time = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <p class="text-sm whitespace-pre-line">${text}</p>
                <span class="text-xs text-gray-400">${sender} ‚Ä¢ ${time}</span>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function addNutritionTypingIndicator() {
            const messagesArea = document.getElementById('nutritionMessagesArea');
            const typingDiv = document.createElement('div');
            const typingId = 'nutrition_typing_' + Date.now();
            
            typingDiv.id = typingId;
            typingDiv.className = 'message-bubble bg-gray-700 p-3 rounded-xl max-w-xs';
            typingDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-xs text-gray-400">Dr. Nutricionista digitando...</span>
                </div>
            `;
            
            messagesArea.appendChild(typingDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            return typingId;
        }

        function removeNutritionTypingIndicator(typingId) {
            const typingElement = document.getElementById(typingId);
            if (typingElement) {
                typingElement.remove();
            }
        }

        async function generateNutritionPlan() {
            const age = document.getElementById('userAge').value;
            const weight = document.getElementById('userWeight').value;
            const goal = document.getElementById('userGoal').value;

            if (!age || !weight || !goal) {
                showNotification('Aten√ß√£o!', 'Preencha todos os campos para gerar o plano', 'warning');
                return;
            }

            userProfile = { age: parseInt(age), weight: parseFloat(weight), goal };

            const planMessage = generateNutritionPlanText(userProfile);
            addNutritionMessage(planMessage, false, 'Dra. Ana Nutri√ß√£o');

            // Gerar lista de alimentos recomendados
            const foodList = generateFoodRecommendations(userProfile);
            addNutritionMessage(foodList, false, 'Dra. Ana Nutri√ß√£o');

            showNotification('Plano gerado!', 'Seu plano alimentar personalizado est√° pronto', 'success');
        }

        function generateNutritionPlanText(profile) {
            const goalTexts = {
                'perder_peso': 'perder peso de forma saud√°vel',
                'ganhar_peso': 'ganhar peso com qualidade',
                'manter_peso': 'manter seu peso atual',
                'ganhar_massa': 'ganhar massa muscular',
                'saude_geral': 'melhorar sua sa√∫de geral'
            };

            const calories = calculateCalories(profile);
            
            return `üçé **Plano Personalizado**

**Perfil:** ${profile.age} anos, ${profile.weight}kg
**Objetivo:** ${goalTexts[profile.goal]}
**Calorias di√°rias:** ~${calories} kcal

**Distribui√ß√£o:**
‚Ä¢ Caf√© da manh√£: 25% (${Math.round(calories * 0.25)} kcal)
‚Ä¢ Almo√ßo: 35% (${Math.round(calories * 0.35)} kcal)
‚Ä¢ Jantar: 30% (${Math.round(calories * 0.30)} kcal)
‚Ä¢ Lanches: 10% (${Math.round(calories * 0.10)} kcal)

**Hidrata√ß√£o:** ${Math.round(profile.weight * 35)}ml de √°gua por dia`;
        }

        function calculateCalories(profile) {
            // F√≥rmula b√°sica TMB + ajuste por objetivo
            let bmr = 10 * profile.weight + 6.25 * 170 - 5 * profile.age; // Assumindo altura m√©dia
            
            const adjustments = {
                'perder_peso': 0.8,
                'ganhar_peso': 1.2,
                'manter_peso': 1.0,
                'ganhar_massa': 1.15,
                'saude_geral': 1.0
            };

            return Math.round(bmr * 1.5 * adjustments[profile.goal]); // Fator atividade moderada
        }

        function generateFoodRecommendations(profile) {
            const foods = {
                'perder_peso': {
                    title: 'ü•ó Alimentos para Perda de Peso',
                    items: [
                        'Vegetais folhosos (espinafre, couve, alface)',
                        'Prote√≠nas magras (frango, peixe, ovos)',
                        'Frutas com baixo √≠ndice glic√™mico (ma√ß√£, p√™ra)',
                        'Gr√£os integrais (quinoa, aveia)',
                        'Leguminosas (feij√£o, lentilha)',
                        'Oleaginosas com modera√ß√£o (castanhas)'
                    ]
                },
                'ganhar_peso': {
                    title: 'üçñ Alimentos para Ganho de Peso',
                    items: [
                        'Carnes vermelhas magras',
                        'Peixes gordurosos (salm√£o, sardinha)',
                        'Carboidratos complexos (batata doce, arroz)',
                        'Frutas cal√≥ricas (banana, abacate)',
                        'Oleaginosas (amendoim, castanhas)',
                        'Latic√≠nios integrais'
                    ]
                },
                'ganhar_massa': {
                    title: 'üí™ Alimentos para Massa Muscular',
                    items: [
                        'Prote√≠nas completas (whey, carne, ovos)',
                        'Carboidratos p√≥s-treino (banana, batata)',
                        'Creatina natural (carne vermelha)',
                        'Amino√°cidos (peixes, frango)',
                        'Carboidratos complexos (aveia, quinoa)',
                        'Gorduras boas (azeite, abacate)'
                    ]
                },
                'manter_peso': {
                    title: '‚öñÔ∏è Alimentos para Manuten√ß√£o',
                    items: [
                        'Dieta balanceada e variada',
                        'Prote√≠nas moderadas (peixe, frango)',
                        'Carboidratos integrais',
                        'Vegetais e frutas diversas',
                        'Gorduras saud√°veis',
                        'Hidrata√ß√£o adequada'
                    ]
                },
                'saude_geral': {
                    title: 'üåü Alimentos para Sa√∫de Geral',
                    items: [
                        'Antioxidantes (frutas vermelhas)',
                        '√îmega-3 (peixes, linha√ßa)',
                        'Fibras (vegetais, gr√£os integrais)',
                        'Probi√≥ticos (iogurte, kefir)',
                        'Vitaminas (frutas c√≠tricas, vegetais)',
                        'Minerais (folhosos verdes, castanhas)'
                    ]
                }
            };

            const recommendation = foods[profile.goal];
            let text = `${recommendation.title}\n\n`;
            recommendation.items.forEach((item, index) => {
                text += `${index + 1}. ${item}\n`;
            });

            return text;
        }

        async function sendNutritionMessage() {
            const input = document.getElementById('nutritionInput');
            const text = input.value.trim();
            
            if (!text) return;

            addNutritionMessage(text, true, 'Voc√™');
            input.value = '';

            // Simular resposta da nutricionista IA
            setTimeout(async () => {
                try {
                    const response = await getNutritionistResponse(text, userProfile);
                    addNutritionMessage(response, false, 'Dra. Ana Nutri√ß√£o');
                } catch (error) {
                    const fallbackResponse = getNutritionFallbackResponse(text);
                    addNutritionMessage(fallbackResponse, false, 'Dra. Ana Nutri√ß√£o');
                }
            }, 1000);
        }

        async function getNutritionistResponse(message, profile) {
            if (!isGeminiConfigured()) {
                throw new Error('API n√£o configurada');
            }

            const profileInfo = profile ? 
                `Perfil do paciente: ${profile.age} anos, ${profile.weight}kg, objetivo: ${profile.goal}` : 
                'Perfil n√£o informado ainda';

            const prompt = `Voc√™ √© Dra. Ana, uma nutricionista experiente e emp√°tica.

CONTEXTO: ${profileInfo}

INSTRU√á√ïES:
- Responda como uma nutricionista profissional
- Use linguagem acess√≠vel e acolhedora
- Forne√ßa orienta√ß√µes nutricionais espec√≠ficas
- Inclua dicas pr√°ticas e receitas quando apropriado
- Limite sua resposta a 150 palavras
- Use portugu√™s brasileiro
- Sempre inclua disclaimer sobre consulta presencial quando necess√°rio

PERGUNTA DO PACIENTE: "${message}"

Responda como Dra. Ana:`;

            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    maxOutputTokens: 250,
                    temperature: 0.4,
                    topP: 0.8,
                    topK: 40
                }
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`Erro da API: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Resposta inv√°lida da API');
            }
        }

        function getNutritionFallbackResponse(message) {
            const msg = message.toLowerCase();
            
            if (msg.includes('receita') || msg.includes('como fazer')) {
                return 'üë©‚Äçüç≥ Adoraria compartilhar receitas! Para receitas personalizadas, preciso conhecer suas restri√ß√µes alimentares e objetivos. Que tipo de prato voc√™ gostaria?';
            }
            
            if (msg.includes('emagrecer') || msg.includes('perder peso')) {
                return 'ü•ó Para emagrecer de forma saud√°vel: priorize vegetais, prote√≠nas magras, beba bastante √°gua e evite a√ß√∫cares. Quer um plano mais espec√≠fico?';
            }
            
            if (msg.includes('ganhar peso') || msg.includes('engordar')) {
                return 'üçñ Para ganho de peso saud√°vel: aumente prote√≠nas, inclua gorduras boas, fa√ßa refei√ß√µes frequentes. Precisa de sugest√µes espec√≠ficas?';
            }
            
            if (msg.includes('suplemento') || msg.includes('vitamina')) {
                return 'üíä Suplementos devem ser prescritos individualmente. Prefira sempre alimentos naturais. Que nutriente espec√≠fico te preocupa?';
            }
            
            return 'ü•ó Entendo sua d√∫vida nutricional. Para orienta√ß√µes mais precisas, seria ideal uma consulta personalizada. Pode me dar mais detalhes sobre sua situa√ß√£o?';
        }

        function addNutritionMessage(text, isUser, sender) {
            const messagesArea = document.getElementById('nutritionMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'ml-auto bg-green-600' : 'bg-gray-700'} p-3 rounded-xl max-w-xs`;
            
            const time = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <p class="text-sm whitespace-pre-line">${text}</p>
                <span class="text-xs text-gray-400">${sender} ‚Ä¢ ${time}</span>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Psychology Chat Functions
        let psychologyChatOpen = false;

        function togglePsychologyChat() {
            const psychologyChatContainer = document.getElementById('psychologyChatContainer');
            psychologyChatOpen = !psychologyChatOpen;
            
            if (psychologyChatOpen) {
                psychologyChatContainer.classList.add('open');
                showNotification('Psic√≥logo!', 'Dr. Psic√≥logo est√° online', 'success');
            } else {
                psychologyChatContainer.classList.remove('open');
            }
        }

        function closePsychologyChat() {
            const psychologyChatContainer = document.getElementById('psychologyChatContainer');
            psychologyChatOpen = false;
            psychologyChatContainer.classList.remove('open');
        }

        async function sendPsychologyChatMessage() {
            const input = document.getElementById('psychologyMessageInput');
            const text = input.value.trim();
            
            if (!text) return;

            // Adicionar mensagem do usu√°rio
            addPsychologyChatMessage(text, true, 'Voc√™');
            input.value = '';

            // Mostrar indicador de digita√ß√£o
            const typingId = addPsychologyTypingIndicator();

            try {
                // Chamar IA Gemini para resposta do psic√≥logo
                const response = await getPsychologistAIResponse(text);
                removePsychologyTypingIndicator(typingId);
                addPsychologyChatMessage(response, false, 'Dr. Psic√≥logo');
                
            } catch (error) {
                removePsychologyTypingIndicator(typingId);
                console.error('Erro na IA Gemini:', error);
                
                // Resposta de fallback
                const fallbackResponse = getPsychologyFallbackResponse(text);
                addPsychologyChatMessage(fallbackResponse, false, 'Dr. Psic√≥logo');
            }
        }

        async function getPsychologistAIResponse(message) {
            if (!isGeminiConfigured()) {
                throw new Error('API n√£o configurada');
            }

            const prompt = `Voc√™ √© o Dr. Psic√≥logo, especialista experiente com 20 anos de experi√™ncia em psicologia cl√≠nica e tratamento de depend√™ncias.

IDENTIDADE OBRIGAT√ìRIA: Voc√™ DEVE se identificar SEMPRE como "Dr. Psic√≥logo" e NUNCA usar outros nomes.

PROTOCOLO DE ATENDIMENTO PSICOL√ìGICO OBRIGAT√ìRIO:
1. SEMPRE inicie com: "Ol√°! Sou o Dr. Psic√≥logo"
2. Mantenha identidade consistente como Dr. Psic√≥logo especialista
3. Use linguagem psicol√≥gica t√©cnica mas acolhedora e n√£o julgadora
4. Seja emp√°tico, compreensivo e demonstre experi√™ncia cl√≠nica
5. Forne√ßa orienta√ß√µes psicol√≥gicas ESPEC√çFICAS para v√≠cios e sa√∫de mental
6. Inclua t√©cnicas pr√°ticas de TCC, mindfulness, enfrentamento
7. Demonstre conhecimento em depend√™ncias, ansiedade, depress√£o
8. Seja encorajador, motivacional e ofere√ßa esperan√ßa realista
9. Ofere√ßa apoio emocional genu√≠no com base cient√≠fica
10. SEMPRE inclua disclaimer: "Esta orienta√ß√£o n√£o substitui consulta psicol√≥gica presencial."
11. Limite resposta a 180 palavras m√°ximo
12. Use portugu√™s brasileiro t√©cnico psicol√≥gico
13. Mantenha consist√™ncia de personalidade profissional experiente

MENSAGEM DO PACIENTE: "${message}"

Responda EXCLUSIVAMENTE como Dr. Psic√≥logo especialista:`;

            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    maxOutputTokens: 250,
                    temperature: 0.4,
                    topP: 0.8,
                    topK: 40
                }
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`Erro da API: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Resposta inv√°lida da API');
            }
        }

        function addPsychologyChatMessage(text, isUser, sender) {
            const messagesArea = document.getElementById('psychologyMessagesArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'ml-auto bg-purple-600' : 'bg-gray-700'} p-3 rounded-xl max-w-xs`;
            
            const time = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <p class="text-sm whitespace-pre-line">${text}</p>
                <span class="text-xs text-gray-400">${sender} ‚Ä¢ ${time}</span>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function addPsychologyTypingIndicator() {
            const messagesArea = document.getElementById('psychologyMessagesArea');
            const typingDiv = document.createElement('div');
            const typingId = 'psychology_typing_' + Date.now();
            
            typingDiv.id = typingId;
            typingDiv.className = 'message-bubble bg-gray-700 p-3 rounded-xl max-w-xs';
            typingDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-xs text-gray-400">Dr. Psic√≥logo digitando...</span>
                </div>
            `;
            
            messagesArea.appendChild(typingDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            return typingId;
        }

        function removePsychologyTypingIndicator(typingId) {
            const typingElement = document.getElementById(typingId);
            if (typingElement) {
                typingElement.remove();
            }
        }

        function startAddictionAssessment() {
            const addictionType = document.getElementById('addictionType').value;
            const addictionLevel = document.getElementById('addictionLevel').value;

            if (!addictionType || !addictionLevel) {
                showNotification('Aten√ß√£o!', 'Selecione o tipo e n√≠vel de depend√™ncia', 'warning');
                return;
            }

            addictionProfile = { type: addictionType, level: addictionLevel };

            const assessmentMessage = generateAddictionAssessment(addictionProfile);
            addAddictionMessage(assessmentMessage, false, 'Dr. Carlos Psicologia');

            const treatmentPlan = generateTreatmentPlan(addictionProfile);
            setTimeout(() => {
                addAddictionMessage(treatmentPlan, false, 'Dr. Carlos Psicologia');
            }, 2000);

            showNotification('Avalia√ß√£o iniciada!', 'Plano de tratamento personalizado gerado', 'success');
        }

        function generateAddictionAssessment(profile) {
            const addictionInfo = {
                'alcool': {
                    name: 'Depend√™ncia de √Ålcool',
                    risks: 'problemas hep√°ticos, cardiovasculares e neurol√≥gicos',
                    symptoms: 'tremores, ansiedade, ins√¥nia, irritabilidade'
                },
                'cigarro': {
                    name: 'Depend√™ncia de Nicotina',
                    risks: 'c√¢ncer, doen√ßas pulmonares e cardiovasculares',
                    symptoms: 'ansiedade, irritabilidade, dificuldade de concentra√ß√£o'
                },
                'drogas': {
                    name: 'Depend√™ncia Qu√≠mica',
                    risks: 'danos cerebrais, problemas card√≠acos, overdose',
                    symptoms: 'abstin√™ncia, mudan√ßas comportamentais, isolamento'
                },
                'jogos': {
                    name: 'V√≠cio em Jogos/Apostas',
                    risks: 'problemas financeiros, familiares e sociais',
                    symptoms: 'ansiedade, depress√£o, mentiras, isolamento'
                },
                'internet': {
                    name: 'Depend√™ncia Digital',
                    risks: 'isolamento social, problemas posturais, ins√¥nia',
                    symptoms: 'ansiedade sem internet, neglig√™ncia de responsabilidades'
                },
                'comida': {
                    name: 'Compuls√£o Alimentar',
                    risks: 'obesidade, diabetes, problemas cardiovasculares',
                    symptoms: 'comer emocional, culpa, perda de controle'
                },
                'compras': {
                    name: 'Compuls√£o por Compras',
                    risks: 'problemas financeiros, endividamento, ansiedade',
                    symptoms: 'compras impulsivas, arrependimento, esconder compras'
                },
                'outro': {
                    name: 'Outro Tipo de Depend√™ncia',
                    risks: 'varia conforme o tipo espec√≠fico',
                    symptoms: 'perda de controle, neglig√™ncia de responsabilidades'
                }
            };

            const levelTexts = {
                'leve': 'uso ocasional com alguns sinais de depend√™ncia',
                'moderado': 'uso regular com impacto na vida di√°ria',
                'severo': 'depend√™ncia forte com graves consequ√™ncias'
            };

            const info = addictionInfo[profile.type];
            const levelText = levelTexts[profile.level];

            return `üß† **Avalia√ß√£o Psicol√≥gica**

**Diagn√≥stico:** ${info.name}
**N√≠vel:** ${levelText}

**Riscos Associados:**
${info.risks}

**Sintomas Comuns:**
${info.symptoms}

**Impacto na Sa√∫de Mental:**
- Ansiedade e depress√£o
- Baixa autoestima
- Isolamento social
- Problemas de relacionamento
- Perda de controle

Vamos trabalhar juntos para sua recupera√ß√£o! üí™`;
        }

        function generateTreatmentPlan(profile) {
            const treatments = {
                'alcool': [
                    'Terapia cognitivo-comportamental',
                    'Grupos de apoio (AA)',
                    'Medica√ß√£o quando necess√°rio',
                    'Desintoxica√ß√£o supervisionada',
                    'Terapia familiar'
                ],
                'cigarro': [
                    'Terapia de reposi√ß√£o de nicotina',
                    'T√©cnicas de relaxamento',
                    'Mudan√ßa de h√°bitos',
                    'Apoio psicol√≥gico',
                    'Medica√ß√£o espec√≠fica'
                ],
                'drogas': [
                    'Desintoxica√ß√£o m√©dica',
                    'Terapia intensiva',
                    'Interna√ß√£o quando necess√°rio',
                    'Grupos de apoio',
                    'Acompanhamento psiqui√°trico'
                ],
                'jogos': [
                    'Terapia cognitivo-comportamental',
                    'Controle financeiro',
                    'Grupos de apoio',
                    'T√©cnicas de autocontrole',
                    'Terapia familiar'
                ],
                'internet': [
                    'Detox digital gradual',
                    'Estabelecimento de limites',
                    'Atividades offline',
                    'Terapia comportamental',
                    'Mindfulness'
                ],
                'comida': [
                    'Terapia nutricional',
                    'Di√°rio alimentar',
                    'T√©cnicas de controle emocional',
                    'Grupos de apoio',
                    'Exerc√≠cios f√≠sicos'
                ],
                'compras': [
                    'Controle financeiro',
                    'Terapia cognitiva',
                    'T√©cnicas de autocontrole',
                    'Identifica√ß√£o de gatilhos',
                    'Atividades alternativas'
                ],
                'outro': [
                    'Avalia√ß√£o espec√≠fica',
                    'Terapia personalizada',
                    'Grupos de apoio',
                    'T√©cnicas de autocontrole',
                    'Acompanhamento cont√≠nuo'
                ]
            };

            const planItems = treatments[profile.type];
            let plan = 'üìã **Plano de Tratamento Personalizado**\n\n';
            
            planItems.forEach((item, index) => {
                plan += `${index + 1}. ${item}\n`;
            });

            plan += '\n**Pr√≥ximos Passos:**\n';
            plan += '‚Ä¢ Consulta presencial recomendada\n';
            plan += '‚Ä¢ Avalia√ß√£o m√©dica completa\n';
            plan += '‚Ä¢ In√≠cio do acompanhamento terap√™utico\n';
            plan += '‚Ä¢ Envolvimento da fam√≠lia/apoio social\n\n';
            plan += 'üíô Lembre-se: a recupera√ß√£o √© poss√≠vel e voc√™ n√£o est√° sozinho!';

            return plan;
        }

        async function sendAddictionMessage() {
            const input = document.getElementById('addictionInput');
            const text = input.value.trim();
            
            if (!text) return;

            addAddictionMessage(text, true, 'Voc√™');
            input.value = '';

            // Simular resposta do psic√≥logo IA
            setTimeout(async () => {
                try {
                    const response = await getPsychologistResponse(text, addictionProfile);
                    addAddictionMessage(response, false, 'Dr. Carlos Psicologia');
                } catch (error) {
                    const fallbackResponse = getPsychologyFallbackResponse(text);
                    addAddictionMessage(fallbackResponse, false, 'Dr. Carlos Psicologia');
                }
            }, 1000);
        }

        async function getPsychologistResponse(message, profile) {
            if (!isGeminiConfigured()) {
                throw new Error('API n√£o configurada');
            }

            const profileInfo = profile ? 
                `Perfil do paciente: depend√™ncia de ${profile.type}, n√≠vel ${profile.level}` : 
                'Perfil n√£o informado ainda';

            const prompt = `Voc√™ √© Dr. Carlos, um psic√≥logo especialista em depend√™ncias e sa√∫de mental.

CONTEXTO: ${profileInfo}

INSTRU√á√ïES:
- Responda como um psic√≥logo experiente e emp√°tico
- Use linguagem acolhedora e n√£o julgadora
- Forne√ßa orienta√ß√µes psicol√≥gicas espec√≠ficas para v√≠cios
- Inclua t√©cnicas pr√°ticas de enfrentamento
- Seja encorajador e motivacional
- Limite sua resposta a 150 palavras
- Use portugu√™s brasileiro
- Sempre inclua disclaimer sobre consulta presencial quando necess√°rio

MENSAGEM DO PACIENTE: "${message}"

Responda como Dr. Carlos:`;

            const requestBody = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    maxOutputTokens: 250,
                    temperature: 0.4,
                    topP: 0.8,
                    topK: 40
                }
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`Erro da API: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Resposta inv√°lida da API');
            }
        }

        function getPsychologyFallbackResponse(message) {
            const msg = message.toLowerCase();
            
            if (msg.includes('ansiedade') || msg.includes('ansioso')) {
                return 'üå∏ A ansiedade √© comum na recupera√ß√£o. Pratique respira√ß√£o profunda: inspire por 4 segundos, segure por 4, expire por 6. Isso acalma o sistema nervoso. Voc√™ est√° no caminho certo!';
            }
            
            if (msg.includes('reca√≠da') || msg.includes('voltei a usar')) {
                return 'üíô Reca√≠das fazem parte do processo de recupera√ß√£o. N√£o se culpe! O importante √© recome√ßar. Identifique o que levou √† reca√≠da e vamos fortalecer suas estrat√©gias de enfrentamento.';
            }
            
            if (msg.includes('fam√≠lia') || msg.includes('relacionamento')) {
                return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Os relacionamentos s√£o fundamentais na recupera√ß√£o. Comunica√ß√£o honesta, estabelecimento de limites e terapia familiar podem ajudar muito. Quer conversar sobre isso?';
            }
            
            if (msg.includes('depress√£o') || msg.includes('triste')) {
                return 'üåà A depress√£o frequentemente acompanha v√≠cios. √â importante tratar ambos. Atividades prazerosas, exerc√≠cios e conex√µes sociais ajudam. Considera acompanhamento psiqui√°trico tamb√©m?';
            }
            
            if (msg.includes('parar') || msg.includes('como fazer')) {
                return 'üéØ Parar requer estrat√©gia: identifique gatilhos, crie novos h√°bitos, busque apoio social, pratique t√©cnicas de relaxamento. Cada pequeno passo conta. Vamos planejar juntos?';
            }
            
            return 'üß† Entendo que est√° passando por um momento dif√≠cil. A recupera√ß√£o √© um processo √∫nico para cada pessoa. Estou aqui para apoi√°-lo. Pode me contar mais sobre como se sente?';
        }

        function addAddictionMessage(text, isUser, sender) {
            const messagesArea = document.getElementById('addictionMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'ml-auto bg-purple-600' : 'bg-gray-700'} p-3 rounded-xl max-w-xs`;
            
            const time = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <p class="text-sm whitespace-pre-line">${text}</p>
                <span class="text-xs text-gray-400">${sender} ‚Ä¢ ${time}</span>
            `;
            
            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Event Listeners for chat inputs
        document.addEventListener('DOMContentLoaded', () => {
            // Nutrition Chat
            const nutritionMessageInput = document.getElementById('nutritionMessageInput');
            if (nutritionMessageInput) {
                nutritionMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendNutritionChatMessage();
                    }
                });
            }
            
            // Psychology Chat
            const psychologyMessageInput = document.getElementById('psychologyMessageInput');
            if (psychologyMessageInput) {
                psychologyMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendPsychologyChatMessage();
                    }
                });
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkApiKeys();
            updateMainButton();
            
            // Request notification permission immediately
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('Notifica√ß√µes ativadas!', 'Voc√™ receber√° alertas de mensagens e consultas', 'success');
                    }
                });
            }
            
            // Welcome notification
            setTimeout(() => {
                showNotification('Bem-vindo!', 'Cl√≠nica Digital Pro - Cuidando da sua sa√∫de com tecnologia', 'success');
            }, 1500);
            
            // Show chat buttons hint
            setTimeout(() => {
                showNotification('Dica!', 'Use os bot√µes do lado direito para acessar nossos servi√ßos', 'info');
            }, 3000);
        });
    </script>
    <script>
    if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker registrado', reg))
        .catch(err => console.error('‚ùå Erro ao registrar o SW:', err));
    });
            }
    </script>
</body>
</html>
